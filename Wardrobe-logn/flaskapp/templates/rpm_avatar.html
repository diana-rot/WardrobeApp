{% extends "base.html" %}

{% block title %}Ready Player Me Avatar{% endblock %}

{% block extra_css %}
<style>
    .rpm-container {
        display: flex;
        flex-direction: column;
        height: 100vh;
        width: 100%;
    }
    
    .rpm-header {
        padding: 20px;
        background-color: #f8f9fa;
        border-bottom: 1px solid #e9ecef;
    }
    
    .rpm-content {
        display: flex;
        flex: 1;
        overflow: hidden;
    }
    
    .rpm-iframe-container {
        flex: 1;
        position: relative;
    }
    
    .rpm-iframe {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        border: none;
    }
    
    .rpm-controls {
        width: 300px;
        padding: 20px;
        background-color: #f8f9fa;
        border-left: 1px solid #e9ecef;
        overflow-y: auto;
    }
    
    .rpm-controls h3 {
        margin-top: 0;
        margin-bottom: 20px;
    }
    
    .rpm-button {
        display: block;
        width: 100%;
        padding: 10px;
        margin-bottom: 10px;
        background-color: #007bff;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        text-align: center;
    }
    
    .rpm-button:hover {
        background-color: #0069d9;
    }
    
    .rpm-button.secondary {
        background-color: #6c757d;
    }
    
    .rpm-button.secondary:hover {
        background-color: #5a6268;
    }
    
    .rpm-avatar-preview {
        margin-top: 20px;
        text-align: center;
    }
    
    .rpm-avatar-preview img {
        max-width: 100%;
        border-radius: 8px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }
    
    .rpm-avatar-preview p {
        margin-top: 10px;
        font-size: 14px;
        color: #6c757d;
    }
    
    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(255, 255, 255, 0.8);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
    }
    
    .loading-spinner {
        width: 50px;
        height: 50px;
        border: 5px solid #f3f3f3;
        border-top: 5px solid #3498db;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    .message {
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 15px;
        border-radius: 4px;
        color: white;
        z-index: 1001;
        animation: fadeIn 0.3s, fadeOut 0.3s 2.7s;
    }
    
    .message.success {
        background-color: #28a745;
    }
    
    .message.error {
        background-color: #dc3545;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }
    
    @keyframes fadeOut {
        from { opacity: 1; }
        to { opacity: 0; }
    }
</style>
{% endblock %}

{% block content %}
<div class="rpm-container">
    <div class="rpm-header">
        <h2>Ready Player Me Avatar Creator</h2>
        <p>Create and customize your 3D avatar using Ready Player Me</p>
    </div>
    
    <div class="rpm-content">
        <div class="rpm-iframe-container">
            <iframe id="rpm-iframe" class="rpm-iframe" src="https://demo.readyplayer.me/avatar" allow="camera *; microphone *"></iframe>
        </div>
        
        <div class="rpm-controls">
            <h3>Avatar Controls</h3>
            
            <button id="save-avatar" class="rpm-button">Save Avatar</button>
            <button id="load-avatar" class="rpm-button secondary">Load Saved Avatar</button>
            <button id="reset-avatar" class="rpm-button secondary">Reset Avatar</button>
            
            <div class="rpm-avatar-preview">
                <h4>Current Avatar</h4>
                <div id="avatar-preview-container">
                    <p>No avatar loaded</p>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="loading-overlay" class="loading-overlay" style="display: none;">
    <div class="loading-spinner"></div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const iframe = document.getElementById('rpm-iframe');
        const saveButton = document.getElementById('save-avatar');
        const loadButton = document.getElementById('load-avatar');
        const resetButton = document.getElementById('reset-avatar');
        const avatarPreviewContainer = document.getElementById('avatar-preview-container');
        const loadingOverlay = document.getElementById('loading-overlay');
        
        let currentAvatarUrl = null;
        
        // Listen for messages from the iframe
        window.addEventListener('message', function(event) {
            // Verify the origin of the message
            if (event.origin !== 'https://demo.readyplayer.me') return;
            
            // Handle avatar URL from Ready Player Me
            if (event.data.eventName === 'v1.avatar.exported') {
                currentAvatarUrl = event.data.avatarUrl;
                updateAvatarPreview(currentAvatarUrl);
                showMessage('Avatar exported successfully!', 'success');
            }
        });
        
        // Save avatar to user profile
        saveButton.addEventListener('click', async function() {
            if (!currentAvatarUrl) {
                showMessage('Please create an avatar first', 'error');
                return;
            }
            
            try {
                showLoading();
                
                const response = await fetch('/api/rpm/save-avatar', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ avatarUrl: currentAvatarUrl })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showMessage('Avatar saved successfully!', 'success');
                } else {
                    showMessage(result.error || 'Failed to save avatar', 'error');
                }
            } catch (error) {
                console.error('Error saving avatar:', error);
                showMessage('Error saving avatar', 'error');
            } finally {
                hideLoading();
            }
        });
        
        // Load saved avatar
        loadButton.addEventListener('click', async function() {
            try {
                showLoading();
                
                const response = await fetch('/api/rpm/get-avatar');
                const result = await response.json();
                
                if (result.success && result.avatarUrl) {
                    currentAvatarUrl = result.avatarUrl;
                    updateAvatarPreview(currentAvatarUrl);
                    
                    // Send message to iframe to load the avatar
                    iframe.contentWindow.postMessage({
                        eventName: 'v1.avatar.load',
                        avatarUrl: currentAvatarUrl
                    }, '*');
                    
                    showMessage('Avatar loaded successfully!', 'success');
                } else {
                    showMessage('No saved avatar found', 'error');
                }
            } catch (error) {
                console.error('Error loading avatar:', error);
                showMessage('Error loading avatar', 'error');
            } finally {
                hideLoading();
            }
        });
        
        // Reset avatar
        resetButton.addEventListener('click', function() {
            iframe.src = iframe.src;
            currentAvatarUrl = null;
            updateAvatarPreview(null);
            showMessage('Avatar reset', 'info');
        });
        
        // Update avatar preview
        function updateAvatarPreview(avatarUrl) {
            if (avatarUrl) {
                avatarPreviewContainer.innerHTML = `
                    <img src="${avatarUrl}" alt="Avatar Preview">
                    <p>Avatar URL: ${avatarUrl.substring(0, 30)}...</p>
                `;
            } else {
                avatarPreviewContainer.innerHTML = '<p>No avatar loaded</p>';
            }
        }
        
        // Show loading overlay
        function showLoading() {
            loadingOverlay.style.display = 'flex';
        }
        
        // Hide loading overlay
        function hideLoading() {
            loadingOverlay.style.display = 'none';
        }
        
        // Show message
        function showMessage(text, type = 'info') {
            const message = document.createElement('div');
            message.className = `message ${type}`;
            message.textContent = text;
            document.body.appendChild(message);
            
            setTimeout(() => {
                message.remove();
            }, 3000);
        }
        
        // Load saved avatar on page load
        loadButton.click();
    });
</script>
{% endblock %} 