{% extends "base.html" %}

{% block title %}Add Clothes to Wardrobe - WardrobeApp{% endblock %}

{% block extra_css %}
<style>
    .card {
        background-color: var(--secondary-color);
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
        padding: 20px;
    }

    .center {
        text-align: center;
    }

    .btn-primary {
        background-color: var(--accent-color);
        border-color: var(--accent-color);
    }

    .btn-primary:hover {
        background-color: #b99593;
        border-color: #b99593;
    }

    .btn-secondary {
        background-color: white;
        border-color: var(--accent-color);
        color: var(--accent-color);
    }

    .btn-secondary:hover {
        background-color: var(--accent-color);
        color: white;
    }

    /* Enhanced Upload Area */
    .upload-area {
        border: 3px dashed var(--accent-color);
        border-radius: 15px;
        padding: 40px;
        text-align: center;
        transition: all 0.3s ease;
        background: rgba(255, 255, 255, 0.1);
        cursor: pointer;
        margin-bottom: 20px;
    }

    .upload-area:hover {
        border-color: var(--primary-color);
        background: rgba(255, 255, 255, 0.2);
        transform: scale(1.02);
    }

    .upload-area.dragover {
        border-color: #28a745;
        background: rgba(40, 167, 69, 0.1);
    }

    .upload-label {
        background: linear-gradient(45deg, var(--accent-color), #d4a5a3);
        color: white;
        border: none;
        padding: 12px 30px;
        border-radius: 25px;
        font-weight: 600;
        transition: all 0.3s ease;
        cursor: pointer;
        display: inline-block;
    }

    .upload-label:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    /* Result styles */
    .prediction-result {
        margin-top: 20px;
        padding: 20px;
        background-color: white;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .result-section {
        margin-bottom: 20px;
        border-bottom: 1px solid #f0f0f0;
        padding-bottom: 15px;
    }

    .result-section:last-child {
        border-bottom: none;
    }

    .result-section h3 {
        font-size: 1.1rem;
        color: var(--primary-color);
        margin-bottom: 10px;
    }

    .result-row {
        display: flex;
        margin-bottom: 10px;
        align-items: center;
    }

    .result-label {
        width: 150px;
        font-weight: 600;
        color: #555;
    }

    .result-value {
        flex: 1;
    }

    .color-preview {
        display: inline-block;
        width: 50px;
        height: 50px;
        border-radius: 8px;
        border: 1px solid #ddd;
        margin-right: 15px;
        vertical-align: middle;
    }

    .color-info {
        display: inline-block;
        vertical-align: middle;
    }

    /* Google Colab Setup Card */
    .colab-setup-card {
        background: linear-gradient(135deg, #4285f4 0%, #34a853 100%);
        border-radius: 15px;
        padding: 25px;
        margin: 25px 0;
        color: white;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
    }

    .colab-setup-card h3 {
        color: white;
        margin-bottom: 15px;
    }

    .colab-url-input {
        width: 100%;
        padding: 12px 15px;
        border: none;
        border-radius: 25px;
        margin: 10px 0;
        font-size: 16px;
    }

    .connect-btn {
        background: white;
        color: #4285f4;
        border: none;
        padding: 12px 30px;
        border-radius: 25px;
        font-weight: 600;
        font-size: 16px;
        transition: all 0.3s ease;
        margin: 10px;
    }

    .connect-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
    }

    .connection-status {
        margin-top: 15px;
        padding: 15px;
        border-radius: 10px;
        display: none;
    }

    .connection-status.success {
        background: rgba(255, 255, 255, 0.2);
        border: 1px solid rgba(255, 255, 255, 0.3);
    }

    .connection-status.error {
        background: rgba(220, 53, 69, 0.2);
        border: 1px solid rgba(220, 53, 69, 0.3);
    }

    /* 3D Model Generation Section */
    .model-generation-section {
        background: linear-gradient(135deg, var(--accent-color) 0%, #d4a5a3 100%);
        border-radius: 15px;
        padding: 25px;
        margin: 25px 0;
        color: white;
        text-align: center;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        display: none;
    }

    .generate-3d-btn {
        background: linear-gradient(45deg, var(--primary-color), #34495e);
        color: white;
        border: none;
        padding: 12px 30px;
        border-radius: 25px;
        font-weight: 600;
        font-size: 16px;
        transition: all 0.3s ease;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        margin: 10px;
    }

    .generate-3d-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
    }

    .generate-3d-btn:disabled {
        background: #ccc;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
    }

    .generation-progress {
        margin: 20px 0;
        display: none;
    }

    .progress-container {
        background: rgba(255, 255, 255, 0.3);
        border-radius: 15px;
        height: 8px;
        overflow: hidden;
        margin: 15px 0;
    }

    .progress-bar {
        height: 100%;
        background: linear-gradient(90deg, var(--primary-color), #34495e);
        border-radius: 15px;
        width: 0%;
        transition: width 0.5s ease;
        animation: shimmer 2s infinite;
    }

    @keyframes shimmer {
        0% { opacity: 1; }
        50% { opacity: 0.7; }
        100% { opacity: 1; }
    }

    .generation-status {
        font-weight: 600;
        margin: 10px 0;
        color: white;
    }

    /* Model Preview Card */
    .model-preview-card {
        background: white;
        border-radius: 15px;
        padding: 20px;
        margin: 20px 0;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        display: none;
        transform: translateY(20px);
        opacity: 0;
        transition: all 0.5s ease;
    }

    .model-preview-card.visible {
        display: block;
        transform: translateY(0);
        opacity: 1;
    }

    .model-info {
        display: flex;
        align-items: center;
        margin-bottom: 15px;
    }

    .model-thumbnail {
        width: 60px;
        height: 60px;
        background: linear-gradient(45deg, var(--accent-color), #d4a5a3);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 15px;
        color: white;
        font-size: 24px;
    }

    .model-actions {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        justify-content: center;
    }

    .model-actions .btn {
        flex: 1;
        min-width: 120px;
        border-radius: 20px;
        padding: 8px 16px;
        margin: 5px;
    }

    /* Loader styles */
    .loader {
        display: inline-block;
        width: 40px;
        height: 40px;
        border: 4px solid #f3f3f3;
        border-top: 4px solid var(--accent-color);
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 20px auto;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    /* Toast Notification */
    .toast-notification {
        position: fixed;
        top: 20px;
        right: 20px;
        max-width: 350px;
        background: white;
        border-radius: 15px;
        padding: 15px 20px;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        z-index: 1000;
        transform: translateX(100%);
        opacity: 0;
        transition: all 0.3s ease;
    }

    .toast-notification.show {
        transform: translateX(0);
        opacity: 1;
    }

    .toast-notification.success {
        border-left: 4px solid #28a745;
    }

    .toast-notification.error {
        border-left: 4px solid #dc3545;
    }

    .toast-notification.warning {
        border-left: 4px solid #ffc107;
    }

    .toast-notification.info {
        border-left: 4px solid #17a2b8;
    }

    .toast-content {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .toast-icon {
        font-size: 20px;
    }

    .toast-text {
        flex: 1;
    }

    .toast-title {
        font-weight: 600;
        margin-bottom: 2px;
    }

    .toast-close {
        background: none;
        border: none;
        font-size: 18px;
        cursor: pointer;
        opacity: 0.7;
        padding: 0;
        width: 20px;
        height: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .toast-close:hover {
        opacity: 1;
    }

    /* Colab Instructions */
    .colab-instructions {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 10px;
        padding: 15px;
        margin-top: 15px;
    }

    .colab-step {
        margin-bottom: 10px;
        font-size: 14px;
    }

    .colab-step strong {
        color: #fff;
    }

    /* Quick View Button */
    .quick-view-floating {
        position: fixed;
        bottom: 30px;
        right: 30px;
        z-index: 1000;
        animation: fadeInBounce 0.8s ease-out;
        display: none;
    }

    @keyframes fadeInBounce {
        0% {
            opacity: 0;
            transform: translateY(50px) scale(0.8);
        }
        50% {
            opacity: 1;
            transform: translateY(-10px) scale(1.1);
        }
        100% {
            opacity: 1;
            transform: translateY(0) scale(1);
        }
    }

    .quick-view-floating .btn {
        position: relative;
        border-radius: 25px;
        padding: 15px 25px;
        font-size: 16px;
        font-weight: 600;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        border: none;
        background: linear-gradient(135deg, var(--accent-color) 0%, #d4a5a3 100%);
        color: white;
        transition: all 0.3s ease;
    }

    .quick-view-floating .btn:hover {
        transform: translateY(-3px);
        box-shadow: 0 12px 35px rgba(0, 0, 0, 0.3);
    }

    /* Responsive Design */
    @media (max-width: 768px) {
        .upload-area {
            padding: 25px 15px;
        }

        .model-actions {
            flex-direction: column;
        }

        .model-actions .btn {
            width: 100%;
            margin-bottom: 8px;
        }

        .quick-view-floating {
            bottom: 20px;
            right: 20px;
        }

        .quick-view-floating .btn {
            padding: 12px 20px;
            font-size: 14px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <!-- Google Colab Setup Card -->
    <div class="colab-setup-card" id="colab-setup-card">
        <h3><i class="fab fa-google"></i> Google Colab 3D Generation</h3>
        <p>Connect to your Google Colab notebook to generate 3D models with free GPU power!</p>

        <div class="colab-url-section">
            <input type="url"
                   class="colab-url-input"
                   id="colab-url-input"
                   placeholder="https://your-ngrok-url.ngrok.io"
                   value="https://f606-34-72-94-244.ngrok-free.app/">
            <button class="connect-btn" onclick="connectToColab()" id="connect-colab-btn">
                <i class="fas fa-plug"></i> Connect to Colab
            </button>
        </div>

        <div class="connection-status" id="colab-connection-status">
            <!-- Connection status will be shown here -->
        </div>

        <div class="colab-instructions">
            <div class="colab-step">
                <strong>Quick Setup:</strong>
                1. Run your Colab TripoSR notebook
                2. Copy the ngrok URL
                3. Paste it above and click Connect
            </div>
        </div>
    </div>

    <!-- Main Upload Section -->
    <div class="card">
        <h1 class="center">
            <i class="fas fa-tshirt"></i> Add clothes to your wardrobe
        </h1>

        <!-- Enhanced Upload Area with Drag & Drop -->
        <div class="upload-area" id="upload-area">
            <div class="upload-content">
                <i class="fas fa-cloud-upload-alt fa-3x mb-3" style="color: var(--accent-color);"></i>
                <h4>Drag & Drop or Click to Upload</h4>
                <p class="text-muted">Support for PNG, JPG, JPEG files</p>
                <label for="imageUpload" class="upload-label">
                    <i class="fas fa-camera"></i> Choose Image
                </label>
                <input type="file" name="file" id="imageUpload" accept=".png, .jpg, .jpeg" style="display: none;">
            </div>
        </div>

        <div class="image-section" style="display:none;">
            <div class="img-preview text-center">
                <div id="imagePreview"></div>
            </div>
            <div class="text-center mt-3">
                <button type="button" class="btn btn-primary btn-lg" id="btn-predict">
                    <i class="fas fa-magic"></i> Analyze & Save to Wardrobe
                </button>
            </div>
        </div>
    </div>

    <!-- Analysis Results -->
    <div class="card">
        <h2><i class="fas fa-chart-line"></i> Analysis Results</h2>
        <div class="d-flex justify-content-center mb-3">
            <div class="loader" id="loading-spinner" style="display:none;"></div>
        </div>
        <div id="result"></div>

        <!-- 3D Model Generation Section -->
        <div id="model-generation-section" class="model-generation-section">
            <h3><i class="fas fa-cube"></i> AI-Powered 3D Model Generation</h3>
            <p>Transform your 2D clothing image into a stunning 3D model using Google Colab GPU</p>

            <button id="generate-3d-model-btn" class="generate-3d-btn">
                <i class="fab fa-google"></i> Generate 3D Model with Colab
            </button>

            <div class="generation-progress" id="generation-progress">
                <div class="generation-status" id="generation-status">Preparing...</div>
                <div class="progress-container">
                    <div class="progress-bar" id="progress-bar"></div>
                </div>
                <small>Using Google Colab GPU - This may take 2-4 minutes...</small>
            </div>

            <!-- Model Preview Card -->
            <div id="model-preview-card" class="model-preview-card">
                <div class="model-info">
                    <div class="model-thumbnail">
                        <i class="fas fa-cube"></i>
                    </div>
                    <div>
                        <h4>3D Model Generated Successfully!</h4>
                        <p class="text-muted">Your clothing item has been converted to a 3D model using Colab GPU</p>
                        <span class="badge" style="background-color: #4285f4; color: white; padding: 4px 8px; border-radius: 10px; font-size: 12px;">
                            <i class="fab fa-google"></i> Colab Generated
                        </span>
                    </div>
                </div>
                <div class="model-actions">
                    <button id="view-3d-model-btn" class="btn btn-primary">
                        <i class="fas fa-eye"></i> View in 3D
                    </button>
                    <button id="download-model-btn" class="btn btn-secondary">
                        <i class="fas fa-download"></i> Download GLB
                    </button>
                    <button id="save-to-wardrobe-btn" class="btn btn-success">
                        <i class="fas fa-save"></i> Save to Wardrobe
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Quick View Button (appears after generation) -->
<div id="quick-view-button" class="quick-view-floating">
    <button class="btn btn-primary btn-lg" onclick="view3DModel()" title="View 3D Model">
        <i class="fas fa-cube"></i>
        <span class="btn-text">View 3D Model</span>
    </button>
</div>

<!-- Toast Notification Template -->
<div id="toast-template" class="toast-notification" style="display: none;">
    <div class="toast-content">
        <div class="toast-icon">
            <i class="fas fa-check-circle"></i>
        </div>
        <div class="toast-text">
            <div class="toast-title"></div>
            <div class="toast-message"></div>
        </div>
        <button class="toast-close" onclick="hideToast(this.closest('.toast-notification'))">√ó</button>
    </div>
</div>

<!-- Simple 3D Viewer Modal -->
<div class="modal fade" id="simple3DModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-xl" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-cube"></i> 3D Model Viewer
                </h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body p-0">
                <div id="simple-3d-viewer" style="width: 100%; height: 70vh; background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);">
                    <!-- 3D viewer will be inserted here -->
                    <div id="viewer-loading" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #666;">
                        <div class="spinner-border text-primary" role="status">
                            <span class="sr-only">Loading...</span>
                        </div>
                        <div class="mt-3">Loading 3D model...</div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">
                    <i class="fas fa-times"></i> Close
                </button>
                <button type="button" class="btn btn-primary" onclick="downloadModel()">
                    <i class="fas fa-download"></i> Download
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Three.js libraries -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>

<script>
// Global variables
let currentUploadedFile = null;
let currentItemData = null;
let generatedModelData = null;
let currentGenerationTaskId = null;
let colabConnected = false;
let simple3DViewer = null;

// Initialize when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    initializeApp();
    // Auto-connect if URL is provided
    const savedUrl = document.getElementById('colab-url-input').value;
    if (savedUrl) {
        connectToColab();
    }
});

function initializeApp() {
    setupEventListeners();
    setupDragAndDrop();
}

function setupEventListeners() {
    // Upload functionality
    document.getElementById('imageUpload').addEventListener('change', handleFileSelect);
    document.getElementById('btn-predict').addEventListener('click', analyzeImage);

    // 3D model generation
    document.getElementById('generate-3d-model-btn').addEventListener('click', generate3DModel);
    document.getElementById('view-3d-model-btn').addEventListener('click', view3DModel);
    document.getElementById('download-model-btn').addEventListener('click', downloadModel);
    document.getElementById('save-to-wardrobe-btn').addEventListener('click', saveToWardrobe);
}

function setupDragAndDrop() {
    const uploadArea = document.getElementById('upload-area');

    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        uploadArea.addEventListener(eventName, preventDefaults, false);
        document.body.addEventListener(eventName, preventDefaults, false);
    });

    ['dragenter', 'dragover'].forEach(eventName => {
        uploadArea.addEventListener(eventName, highlight, false);
    });

    ['dragleave', 'drop'].forEach(eventName => {
        uploadArea.addEventListener(eventName, unhighlight, false);
    });

    uploadArea.addEventListener('drop', handleDrop, false);

    function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    }

    function highlight() {
        uploadArea.classList.add('dragover');
    }

    function unhighlight() {
        uploadArea.classList.remove('dragover');
    }

    function handleDrop(e) {
        const dt = e.dataTransfer;
        const files = dt.files;
        handleFiles(files);
    }
}

function handleFiles(files) {
    if (files.length > 0) {
        const file = files[0];
        if (file.type.startsWith('image/')) {
            currentUploadedFile = file;
            displayImagePreview(file);
        } else {
            showToast('Please select a valid image file (PNG, JPG, JPEG)', 'error');
        }
    }
}

function handleFileSelect(event) {
    const file = event.target.files[0];
    if (file) {
        currentUploadedFile = file;
        displayImagePreview(file);
    }
}

function displayImagePreview(file) {
    const reader = new FileReader();
    reader.onload = function(e) {
        const imagePreview = document.getElementById('imagePreview');
        imagePreview.innerHTML = `
            <img src="${e.target.result}" alt="Preview" class="img-fluid" style="max-height: 300px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.2);">
        `;
        document.querySelector('.image-section').style.display = 'block';
    };
    reader.readAsDataURL(file);
}

// Colab Connection Functions
function connectToColab() {
    const urlInput = document.getElementById('colab-url-input');
    const connectBtn = document.getElementById('connect-colab-btn');
    const colabUrl = urlInput.value.trim();

    if (!colabUrl) {
        showToast('Please enter a Colab API URL', 'warning');
        return;
    }

    // Show loading state
    connectBtn.disabled = true;
    connectBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Connecting...';

    fetch('/api/set-colab-url', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ colab_url: colabUrl })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('‚úÖ Connected to Colab API successfully!', 'success');
            showColabConnectionStatus(true, 'Connected and ready for 3D generation');
            colabConnected = true;

            // Enable 3D generation
            const generateBtn = document.getElementById('generate-3d-model-btn');
            generateBtn.disabled = false;
            generateBtn.innerHTML = '<i class="fab fa-google"></i> Generate 3D Model with Colab';
        } else {
            throw new Error(data.error || 'Failed to connect');
        }
    })
    .catch(error => {
        console.error('Error connecting to Colab:', error);
        showToast('‚ùå Failed to connect to Colab API', 'error');
        showColabConnectionStatus(false, error.message);
        colabConnected = false;
    })
    .finally(() => {
        connectBtn.disabled = false;
        connectBtn.innerHTML = '<i class="fas fa-plug"></i> Connect to Colab';
    });
}

function showColabConnectionStatus(success, message) {
    const statusDiv = document.getElementById('colab-connection-status');
    statusDiv.style.display = 'block';
    statusDiv.className = `connection-status ${success ? 'success' : 'error'}`;
    statusDiv.innerHTML = `
        <div class="d-flex align-items-center">
            <i class="fas fa-${success ? 'check-circle' : 'exclamation-triangle'} mr-2"></i>
            <span>${message}</span>
        </div>
    `;
}

// Image Analysis Function
function analyzeImage() {
    if (!currentUploadedFile) {
        showToast('Please select an image first', 'warning');
        return;
    }

    const loadingSpinner = document.getElementById('loading-spinner');
    const resultDiv = document.getElementById('result');
    const btnPredict = document.getElementById('btn-predict');

    // Show loading state
    loadingSpinner.style.display = 'block';
    btnPredict.disabled = true;
    btnPredict.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Analyzing...';
    resultDiv.innerHTML = '';

    // Create FormData
    const formData = new FormData();
    formData.append('file', currentUploadedFile);

    // Send to backend
    fetch('/wardrobe', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        loadingSpinner.style.display = 'none';
        btnPredict.disabled = false;
        btnPredict.innerHTML = '<i class="fas fa-magic"></i> Analyze & Save to Wardrobe';

        if (data.success) {
            currentItemData = data;
            displayAnalysisResults(data);
            showModelGenerationSection();
            showToast('‚úÖ Image analyzed successfully!', 'success');
        } else {
            showToast(data.error || 'Analysis failed', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        loadingSpinner.style.display = 'none';
        btnPredict.disabled = false;
        btnPredict.innerHTML = '<i class="fas fa-magic"></i> Analyze & Save to Wardrobe';
        showToast('Error analyzing image', 'error');
    });
}

function displayAnalysisResults(data) {
    const resultDiv = document.getElementById('result');

    let resultHTML = `
        <div class="prediction-result">
            <div class="result-section">
                <h3><i class="fas fa-tag"></i> Clothing Classification</h3>
                <div class="result-row">
                    <div class="result-label">Category:</div>
                    <div class="result-value"><strong>${data.prediction}</strong></div>
                </div>
                <div class="result-row">
                    <div class="result-label">Confidence:</div>
                    <div class="result-value">${(data.confidence * 100).toFixed(1)}%</div>
                </div>
            </div>
    `;

    if (data.color) {
        const colorRGB = data.color.rgb || [128, 128, 128];
        resultHTML += `
            <div class="result-section">
                <h3><i class="fas fa-palette"></i> Color Analysis</h3>
                <div class="result-row">
                    <div class="result-label">Dominant Color:</div>
                    <div class="result-value">
                        <div class="color-preview" style="background-color: rgb(${colorRGB.join(',')});"></div>
                        <div class="color-info">
                            <strong>RGB: ${colorRGB.join(', ')}</strong><br>
                            <small>Coverage: ${(data.color.percentage * 100).toFixed(1)}%</small>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }

    resultHTML += '</div>';
    resultDiv.innerHTML = resultHTML;
}

function showModelGenerationSection() {
    const section = document.getElementById('model-generation-section');
    section.style.display = 'block';
    section.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

// 3D Model Generation with Colab
function generate3DModel() {
    if (!currentUploadedFile) {
        showToast('Please upload an image first', 'warning');
        return;
    }

    if (!colabConnected) {
        showToast('Please connect to Colab first', 'warning');
        document.getElementById('colab-setup-card').scrollIntoView({ behavior: 'smooth' });
        return;
    }

    const generateBtn = document.getElementById('generate-3d-model-btn');
    const progressDiv = document.getElementById('generation-progress');
    const statusText = document.getElementById('generation-status');
    const progressBar = document.getElementById('progress-bar');

    // Show progress
    generateBtn.disabled = true;
    generateBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating with Colab...';
    progressDiv.style.display = 'block';

    // Reset progress
    progressBar.style.width = '0%';
    statusText.textContent = 'Uploading to Colab GPU...';

    // Create FormData with the image
    const formData = new FormData();
    formData.append('image', currentUploadedFile);

    // Call the Colab-only API
    fetch('/api/generate-3d-model', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            currentGenerationTaskId = data.task_id;
            showToast(`üöÄ 3D generation started with Colab GPU! ${data.estimated_time}`, 'info');
            startStatusPolling();
        } else {
            throw new Error(data.error || 'Failed to start generation');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast(`‚ùå Error: ${error.message}`, 'error');
        resetGenerationUI();
    });
}

function startStatusPolling() {
    if (!currentGenerationTaskId) return;

    const statusText = document.getElementById('generation-status');
    const progressBar = document.getElementById('progress-bar');

    const pollStatus = () => {
        fetch(`/api/check-generation-status?task_id=${currentGenerationTaskId}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Update progress
                    statusText.textContent = data.message;
                    progressBar.style.width = (data.progress * 100) + '%';

                    if (data.status === 'completed') {
                        handleGenerationSuccess(data);
                    } else if (data.status === 'failed') {
                        handleGenerationFailure(data);
                    } else {
                        // Still processing, check again
                        setTimeout(pollStatus, 3000);
                    }
                } else {
                    throw new Error(data.error || 'Status check failed');
                }
            })
            .catch(error => {
                console.error('Error checking status:', error);
                showToast(`‚ùå Error: ${error.message}`, 'error');
                resetGenerationUI();
            });
    };

    // Start polling
    setTimeout(pollStatus, 3000);
}

function handleGenerationSuccess(data) {
    generatedModelData = {
        model_path: data.model_path,
        task_id: currentGenerationTaskId,
        file_size: data.file_size,
        completed_at: data.completed_at,
        method: 'colab'
    };

    const progressDiv = document.getElementById('generation-progress');
    const previewCard = document.getElementById('model-preview-card');

    progressDiv.style.display = 'none';
    previewCard.classList.add('visible');

    resetGenerationUI();
    showToast('üéâ 3D model generated successfully with Colab!', 'success');
    showQuickViewButton();

    // Auto-save to wardrobe
    if (currentItemData && currentItemData._id) {
        autoSave3DModel();
    }

    currentGenerationTaskId = null;
}

function handleGenerationFailure(data) {
    const errorMessage = data.error || data.message || 'Generation failed';
    showToast(`‚ùå Generation failed: ${errorMessage}`, 'error');
    resetGenerationUI();
    currentGenerationTaskId = null;
}

function resetGenerationUI() {
    const generateBtn = document.getElementById('generate-3d-model-btn');
    const progressDiv = document.getElementById('generation-progress');

    if (generateBtn) {
        generateBtn.disabled = false;
        generateBtn.innerHTML = '<i class="fab fa-google"></i> Generate 3D Model with Colab';
    }

    if (progressDiv) {
        progressDiv.style.display = 'none';
    }
}

function autoSave3DModel() {
    if (!generatedModelData || !currentItemData) return;

    fetch('/api/save-3d-model', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            item_id: currentItemData._id || currentItemData.id,
            model_path: generatedModelData.model_path
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('‚úÖ 3D model automatically saved to wardrobe', 'success');
        }
    })
    .catch(error => {
        console.error('Auto-save error:', error);
    });
}

// 3D Model Interaction Functions
function view3DModel() {
    if (!generatedModelData) {
        showToast('No 3D model available', 'warning');
        return;
    }

    // Show the modal
    $('#simple3DModal').modal('show');

    // Initialize viewer when modal is shown
    $('#simple3DModal').on('shown.bs.modal', function () {
        if (!simple3DViewer) {
            initSimple3DViewer();
        }
        loadModelInViewer(generatedModelData.model_path);
    });
}

function initSimple3DViewer() {
    const container = document.getElementById('simple-3d-viewer');

    // Scene setup
    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0xf5f7fa);

    // Camera
    const camera = new THREE.PerspectiveCamera(75, container.clientWidth / container.clientHeight, 0.1, 1000);
    camera.position.set(3, 3, 3);

    // Renderer
    const renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(container.clientWidth, container.clientHeight);
    renderer.shadowMap.enabled = true;
    container.appendChild(renderer.domElement);

    // Controls
    const controls = new THREE.OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;

    // Lights
    const ambientLight = new THREE.AmbientLight(0xffffff, 0.4);
    scene.add(ambientLight);
    const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
    directionalLight.position.set(5, 10, 5);
    scene.add(directionalLight);

    // Animation loop
    function animate() {
        requestAnimationFrame(animate);
        controls.update();
        renderer.render(scene, camera);
    }
    animate();

    // Store viewer components
    simple3DViewer = { scene, camera, renderer, controls };

    // Handle resize
    window.addEventListener('resize', () => {
        camera.aspect = container.clientWidth / container.clientHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(container.clientWidth, container.clientHeight);
    });
}

function loadModelInViewer(modelPath) {
    const loadingDiv = document.getElementById('viewer-loading');
    loadingDiv.style.display = 'block';

    const loader = new THREE.GLTFLoader();
    loader.load(
        modelPath,
        (gltf) => {
            // Clear existing models
            const objectsToRemove = [];
            simple3DViewer.scene.traverse((child) => {
                if (child.isMesh) {
                    objectsToRemove.push(child);
                }
            });
            objectsToRemove.forEach(obj => {
                simple3DViewer.scene.remove(obj);
            });

            // Add new model
            const model = gltf.scene;

            // Center and scale the model
            const box = new THREE.Box3().setFromObject(model);
            const center = box.getCenter(new THREE.Vector3());
            const size = box.getSize(new THREE.Vector3());

            model.position.x = -center.x;
            model.position.y = -center.y;
            model.position.z = -center.z;

            const maxDim = Math.max(size.x, size.y, size.z);
            const scale = 2 / maxDim;
            model.scale.setScalar(scale);

            simple3DViewer.scene.add(model);

            // Reset camera
            simple3DViewer.camera.position.set(3, 3, 3);
            simple3DViewer.controls.target.set(0, 0, 0);

            loadingDiv.style.display = 'none';
            showToast('‚úÖ 3D model loaded successfully', 'success');
        },
        (progress) => {
            // Progress callback
        },
        (error) => {
            console.error('Error loading model:', error);
            loadingDiv.style.display = 'none';
            showToast('‚ùå Error loading 3D model', 'error');
        }
    );
}

function downloadModel() {
    if (!generatedModelData || !generatedModelData.model_path) {
        showToast('No 3D model available for download', 'warning');
        return;
    }

    const link = document.createElement('a');
    link.href = generatedModelData.model_path;
    link.download = `colab_3d_model_${Date.now()}.glb`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);

    showToast('üì• 3D model download started', 'success');
}

function saveToWardrobe() {
    if (!currentItemData || !generatedModelData) {
        showToast('No model data to save', 'warning');
        return;
    }

    const saveBtn = document.getElementById('save-to-wardrobe-btn');
    saveBtn.disabled = true;
    saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';

    fetch('/api/save-3d-model', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            item_id: currentItemData._id || currentItemData.id,
            model_path: generatedModelData.model_path
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('‚úÖ 3D model saved to wardrobe successfully!', 'success');
            currentItemData.model_3d_path = generatedModelData.model_path;
            currentItemData.has_3d_model = true;
        } else {
            throw new Error(data.error || 'Failed to save model');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast(`‚ùå Error saving to wardrobe: ${error.message}`, 'error');
    })
    .finally(() => {
        saveBtn.disabled = false;
        saveBtn.innerHTML = '<i class="fas fa-save"></i> Save to Wardrobe';
    });
}

function showQuickViewButton() {
    if (generatedModelData && generatedModelData.model_path) {
        const quickViewBtn = document.getElementById('quick-view-button');
        quickViewBtn.style.display = 'block';
    }
}

// Toast notification system
function showToast(message, type = 'success', title = '') {
    const toastTemplate = document.getElementById('toast-template');
    const toast = toastTemplate.cloneNode(true);

    toast.id = 'toast-' + Date.now();
    toast.style.display = 'block';
    toast.classList.add(type);

    const iconMap = {
        success: 'fa-check-circle',
        error: 'fa-exclamation-circle',
        warning: 'fa-exclamation-triangle',
        info: 'fa-info-circle'
    };

    const icon = toast.querySelector('.toast-icon i');
    icon.className = `fas ${iconMap[type] || iconMap.success}`;

    const titleElement = toast.querySelector('.toast-title');
    const messageElement = toast.querySelector('.toast-message');

    if (title) {
        titleElement.textContent = title;
    } else {
        titleElement.style.display = 'none';
    }
    messageElement.textContent = message;

    document.body.appendChild(toast);

    // Show toast
    setTimeout(() => {
        toast.classList.add('show');
    }, 100);

    // Auto hide after 5 seconds
    setTimeout(() => {
        hideToast(toast);
    }, 5000);
}

function hideToast(toast) {
    toast.classList.remove('show');
    setTimeout(() => {
        if (toast.parentNode) {
            toast.parentNode.removeChild(toast);
        }
    }, 300);
}
</script>
{% endblock %}