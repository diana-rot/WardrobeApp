{% extends "base.html" %}

{% block title %}Add Clothes to Wardrobe - WardrobeApp{% endblock %}

{% block extra_css %}
<style>
    .card {
        background-color: var(--secondary-color);
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
        padding: 20px;
    }

    .center {
        text-align: center;
    }

    .btn-primary {
        background-color: var(--accent-color);
        border-color: var(--accent-color);
    }

    .btn-primary:hover {
        background-color: #b99593;
        border-color: #b99593;
    }

    .btn-secondary {
        background-color: white;
        border-color: var(--accent-color);
        color: var(--accent-color);
    }

    .btn-secondary:hover {
        background-color: var(--accent-color);
        color: white;
    }

    /* Result styles - updated for new layout */
    .prediction-result {
        margin-top: 20px;
        padding: 20px;
        background-color: white;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .result-section {
        margin-bottom: 20px;
        border-bottom: 1px solid #f0f0f0;
        padding-bottom: 15px;
    }

    .result-section:last-child {
        border-bottom: none;
    }

    .result-section h3 {
        font-size: 1.1rem;
        color: var(--primary-color);
        margin-bottom: 10px;
    }

    .result-row {
        display: flex;
        margin-bottom: 10px;
        align-items: center;
    }

    .result-label {
        width: 150px;
        font-weight: 600;
        color: #555;
    }

    .result-value {
        flex: 1;
    }

    .color-preview {
        display: inline-block;
        width: 50px;
        height: 50px;
        border-radius: 8px;
        border: 1px solid #ddd;
        margin-right: 15px;
        vertical-align: middle;
    }

    .color-info {
        display: inline-block;
        vertical-align: middle;
    }

    /* 3D Clothes Viewer Styles - enhanced version */
    #canvas-container {
        width: 100%;
        height: 400px;
        background-color: #f5f5f5;
        border-radius: 10px;
        overflow: hidden;
        position: relative;
    }

    .viewer-controls {
        background-color: var(--secondary-color, #f8f8f8);
        border-radius: 10px;
        padding: 15px;
        margin-bottom: 15px;
    }

    .material-preview {
        display: flex;
        align-items: center;
        margin-bottom: 15px;
    }

    .material-image {
        width: 80px;
        height: 80px;
        object-fit: cover;
        border-radius: 8px;
        margin-right: 15px;
        border: 1px solid #ddd;
    }

    .material-info {
        flex: 1;
    }

    .material-name {
        font-weight: bold;
        margin-bottom: 5px;
    }

    .material-type {
        font-style: italic;
        color: #666;
    }

    .pattern-preview {
        margin-top: 10px;
        padding-top: 10px;
        border-top: 1px solid #eee;
    }

    .pattern-badge {
        display: inline-block;
        padding: 3px 8px;
        background-color: var(--accent-color, #b99593);
        color: white;
        border-radius: 12px;
        font-size: 12px;
        margin-right: 5px;
    }

    .material-settings {
        margin-top: 15px;
    }

    .setting-group {
        margin-bottom: 12px;
    }

    .setting-label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
    }

    .slider-container {
        display: flex;
        align-items: center;
    }

    .slider {
        flex: 1;
        margin-right: 10px;
    }

    .slider-value {
        width: 40px;
        text-align: right;
    }

    #loading-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.7);
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 100;
        visibility: hidden;
        opacity: 0;
        transition: opacity 0.3s;
    }

    #loading-overlay.visible {
        visibility: visible;
        opacity: 1;
    }

    .spinner {
        border: 5px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top: 5px solid #fff;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    #loading-text {
        margin-top: 15px;
        color: white;
        font-weight: bold;
    }

    #error-toast {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background-color: #f44336;
        color: white;
        padding: 15px;
        border-radius: 4px;
        z-index: 1000;
        transition: opacity 0.5s;
        opacity: 0;
        max-width: 300px;
    }

    .tab-nav {
        display: flex;
        border-bottom: 1px solid #ddd;
        margin-bottom: 15px;
    }

    .tab-button {
        background: none;
        border: none;
        padding: 8px 15px;
        cursor: pointer;
        font-weight: bold;
        color: #666;
        border-bottom: 3px solid transparent;
    }

    .tab-button.active {
        color: var(--accent-color, #b99593);
        border-bottom: 3px solid var(--accent-color, #b99593);
    }

    .tab-panel {
        display: none;
    }

    .tab-panel.active {
        display: block;
    }

    /* Toggle for upload/view modes */
    .mode-toggle {
        display: flex;
        justify-content: center;
        margin-bottom: 20px;
    }

    .mode-toggle .btn {
        border-radius: 0;
    }

    .mode-toggle .btn:first-child {
        border-top-left-radius: 4px;
        border-bottom-left-radius: 4px;
    }

    .mode-toggle .btn:last-child {
        border-top-right-radius: 4px;
        border-bottom-right-radius: 4px;
    }

    /* Container modes */
    .upload-container, .viewer-container {
        display: none;
    }

    .upload-container.active, .viewer-container.active {
        display: block;
    }

    /* Texture Preview Styles */
    .texture-preview-container {
        margin-top: 20px;
        padding: 15px;
        background-color: var(--secondary-color);
        border-radius: 10px;
    }

    .texture-preview {
        display: flex;
        gap: 20px;
        margin-bottom: 20px;
    }

    /* Style for texture preview in results */
    .texture-preview-image {
        width: 80px;
        height: 80px;
        object-fit: cover;
        border-radius: 8px;
        border: 1px solid #ddd;
    }

    .texture-image {
        width: 200px;
        height: 200px;
        object-fit: contain;
        border: 1px solid #ddd;
        border-radius: 8px;
        background-color: white;
    }

    .texture-controls {
        flex: 1;
    }

    .texture-properties {
        margin-top: 15px;
    }

    .texture-property {
        margin-bottom: 10px;
    }

    .texture-property label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
    }

    .texture-property input[type="range"] {
        width: 100%;
        margin-bottom: 5px;
    }

    .texture-property .value {
        font-size: 0.9em;
        color: #666;
    }

    .texture-actions {
        margin-top: 20px;
        display: flex;
        gap: 10px;
    }

    .texture-actions button {
        padding: 8px 15px;
        border-radius: 5px;
        border: none;
        cursor: pointer;
        font-weight: bold;
    }

    .texture-actions .save-btn {
        background-color: var(--accent-color);
        color: white;
    }

    .texture-actions .reset-btn {
        background-color: #ddd;
        color: #333;
    }

    .action-buttons {
        display: flex;
        justify-content: space-between;
        margin-top: 20px;
    }

    /* Enhanced Fabric Visualization Styles */
    .fabric-sample {
        display: inline-block;
        width: 60px;
        height: 60px;
        margin-right: 10px;
        border-radius: 5px;
        background-size: cover;
        background-position: center;
        border: 2px solid #ddd;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .material-properties-table {
        width: 100%;
        margin-top: 10px;
        border-collapse: collapse;
    }

    .material-properties-table th,
    .material-properties-table td {
        padding: 8px;
        text-align: left;
        border-bottom: 1px solid #ddd;
    }

    .material-properties-table th {
        background-color: #f8f8f8;
        font-weight: 600;
    }

    .fabric-info-card {
        border: 1px solid #eaeaea;
        border-radius: 8px;
        padding: 15px;
        margin-top: 15px;
        background-color: white;
    }

    .fabric-info-title {
        font-weight: 600;
        margin-bottom: 10px;
        display: flex;
        align-items: center;
    }

    .fabric-characteristics {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-top: 10px;
    }

    .fabric-characteristic {
        background-color: #f1f1f1;
        padding: 5px 10px;
        border-radius: 20px;
        font-size: 0.9em;
    }

    /* Normal Map Visualization */
    .normal-map-preview {
        margin-top: 15px;
        padding: 10px;
        background-color: #f8f8f8;
        border-radius: 8px;
    }

    .normal-map-preview h4 {
        margin-bottom: 10px;
        font-size: 0.95rem;
    }

    .normal-map-img {
        width: 100%;
        max-width: 250px;
        height: auto;
        border-radius: 5px;
        border: 1px solid #ddd;
    }

    .view-mode-toggle {
        margin: 15px 0;
        text-align: center;
    }

    .view-mode-button {
        padding: 8px 15px;
        margin: 0 5px;
        border: 1px solid var(--accent-color);
        background-color: white;
        color: var(--accent-color);
        border-radius: 20px;
        cursor: pointer;
        transition: all 0.2s;
    }

    .view-mode-button.active {
        background-color: var(--accent-color);
        color: white;
    }

    /* Enhanced 3D view control panel */
    .controls-panel {
        margin-top: 20px;
        padding: 15px;
        background-color: #f8f8f8;
        border-radius: 10px;
    }

    .controls-panel h3 {
        margin-bottom: 15px;
        font-size: 1.1rem;
    }

    .control-row {
        display: flex;
        align-items: center;
        margin-bottom: 12px;
    }

    .control-label {
        flex: 1;
        font-weight: 500;
    }

    .control-input {
        flex: 2;
    }

    /* Fabric swatch styles */
    .fabric-swatch-container {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-top: 15px;
    }

    .fabric-swatch {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background-size: cover;
        background-position: center;
        cursor: pointer;
        transition: transform 0.2s;
        border: 2px solid transparent;
    }

    .fabric-swatch:hover {
        transform: scale(1.1);
    }

    .fabric-swatch.selected {
        border-color: var(--accent-color);
    }

    /* Debug panel for color analysis */
    .debug-panel {
        margin-top: 20px;
        padding: 15px;
        background-color: #f3f3f3;
        border-radius: 8px;
        border: 1px solid #ddd;
    }

    .debug-panel h3 {
        margin-bottom: 10px;
        color: #333;
    }

    .debug-image {
        max-width: 100%;
        height: auto;
        border-radius: 5px;
        margin-top: 10px;
    }

    .loader {
        display: inline-block;
        width: 40px;
        height: 40px;
        border: 4px solid #f3f3f3;
        border-top: 4px solid var(--accent-color, #b99593);
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 20px auto;
    }

    /* Material Analysis Styles */
    .material-analysis-container {
        padding: 15px;
        background-color: #f9f9f9;
        border-radius: 8px;
        margin-top: 15px;
    }

    .material-type-badge {
        display: inline-block;
        padding: 4px 8px;
        background-color: var(--accent-color, #b99593);
        color: white;
        border-radius: 4px;
        font-size: 14px;
        margin-left: 10px;
    }

    .confidence-badge {
        display: inline-block;
        padding: 3px 6px;
        background-color: #28a745;
        color: white;
        border-radius: 10px;
        font-size: 12px;
        margin-left: 8px;
    }

    .alternative-material {
        display: inline-block;
        padding: 3px 8px;
        background-color: #e9ecef;
        color: #495057;
        border-radius: 12px;
        font-size: 12px;
        margin-right: 5px;
        margin-bottom: 5px;
    }

    .alternative-material .confidence {
        font-size: 10px;
        color: #6c757d;
        margin-left: 4px;
    }

    .progress-bar-container {
        height: 10px;
        background-color: #e9ecef;
        border-radius: 5px;
        margin-top: 5px;
        overflow: hidden;
    }

    .progress-bar {
        height: 100%;
        background-color: var(--accent-color, #b99593);
        border-radius: 5px;
    }

    .material-property-row {
        display: flex;
        align-items: center;
        margin-bottom: 8px;
    }

    .material-property-name {
        flex: 1;
        font-weight: 500;
    }

    .material-property-value {
        flex: 2;
    }

    .care-instruction {
        display: flex;
        align-items: center;
        margin-bottom: 5px;
    }

    .care-icon {
        width: 24px;
        height: 24px;
        margin-right: 10px;
        background-color: #f1f1f1;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .care-text {
        flex: 1;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="mode-toggle">
        <button class="btn btn-primary active" id="upload-mode-btn">Upload Clothes</button>
        <button class="btn btn-secondary" id="view-mode-btn">3D Clothes Viewer</button>
    </div>

    <!-- Upload Mode Content -->
    <div class="upload-container active">
        <div class="card">
            <h1 class="center">Add clothes to your wardrobe:</h1>
            <form id="upload-file" action="/predict" method="post" enctype="multipart/form-data">
                <div class="center">
                    <label for="imageUpload" class="upload-label btn btn-primary">
                        Choose Image...
                    </label>
                    <input type="file" name="file" id="imageUpload" accept=".png, .jpg, .jpeg" style="display: none;">
                </div>
            </form>
            <div class="image-section" style="display:none;">
                <div class="img-preview">
                    <div id="imagePreview"></div>
                </div>
                <div class="text-center mt-3">
                    <button type="button" class="btn btn-primary btn-lg" id="btn-predict">Predict and Save</button>
                </div>
            </div>
        </div>

        <div class="card">
            <h2>The result:</h2>
            <div class="loader" style="display:none;"></div>
            <div id="result"></div>

            <!-- Debug panel (initially hidden) -->
            <div id="color-debug-panel" class="debug-panel" style="display: none;">
                <h3>Color Analysis Debug</h3>
                <button id="show-debug-btn" class="btn btn-secondary">Show Color Analysis Details</button>
                <div id="debug-image-container" style="display: none;"></div>
            </div>

            <!-- Add this inside your template where you want the material analysis to appear -->
            <div id="material-analysis-section" class="result-section" style="display: none;">
                <h3>Material Analysis</h3>
                <div id="material-analysis-container" class="material-analysis-container">
                    <div class="result-row">
                        <div class="result-label">Material Type:</div>
                        <div class="result-value">
                            <span id="material-type-result" class="font-weight-bold"></span>
                            <span class="badge badge-pill badge-primary ml-2" id="material-confidence"></span>
                        </div>
                    </div>

                    <div class="result-row">
                        <div class="result-label">Alternatives:</div>
                        <div class="result-value" id="alternative-materials"></div>
                    </div>

                    <div class="result-row">
                        <div class="result-label">Properties:</div>
                        <div class="result-value">
                            <div class="material-property-row">
                                <div class="material-property-name">Breathability:</div>
                                <div class="material-property-value">
                                    <div class="progress-bar-container">
                                        <div class="progress-bar" id="breathability-bar" style="width: 70%"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="material-property-row">
                                <div class="material-property-name">Durability:</div>
                                <div class="material-property-value">
                                    <div class="progress-bar-container">
                                        <div class="progress-bar" id="durability-bar" style="width: 85%"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="material-property-row">
                                <div class="material-property-name">Warmth:</div>
                                <div class="material-property-value">
                                    <div class="progress-bar-container">
                                        <div class="progress-bar" id="warmth-bar" style="width: 50%"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="result-row">
                        <div class="result-label">Care:</div>
                        <div class="result-value" id="care-instructions">
                            <div class="care-instruction">
                                <div class="care-icon">
                                    <i class="fas fa-tint"></i>
                                </div>
                                <div class="care-text">Machine wash at 30°C</div>
                            </div>
                            <div class="care-instruction">
                                <div class="care-icon">
                                    <i class="fas fa-wind"></i>
                                </div>
                                <div class="care-text">Tumble dry low</div>
                            </div>
                            <div class="care-instruction">
                                <div class="care-icon">
                                    <i class="fas fa-iron"></i>
                                </div>
                                <div class="care-text">Iron on medium heat</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 3D Clothes Viewer Mode Content (Enhanced Version) -->
    <div class="viewer-container">
        <div class="card">
            <h1 class="center">Enhanced 3D Clothes Viewer</h1>
            <p class="center">Interactive fabric and 3D clothing visualization with realistic material properties</p>

            <div class="view-mode-toggle">
                <button class="view-mode-button active" data-mode="standard">Standard View</button>
                <button class="view-mode-button" data-mode="fabric">Fabric Detail</button>
                <button class="view-mode-button" data-mode="realistic">Realistic Lighting</button>
            </div>

            <div class="row">
                <div class="col-md-8">
                    <div id="canvas-container">
                        <!-- 3D viewer will be inserted here -->
                        <div id="loading-overlay">
                            <div class="spinner"></div>
                            <div id="loading-text">Loading 3D model...</div>
                        </div>
                    </div>

                    <!-- Enhanced Fabric Information Display -->
                    <div class="fabric-info-card" id="fabric-info-panel" style="display:none;">
                        <div class="fabric-info-title">
                            <div class="fabric-sample" id="fabric-sample"></div>
                            <div>
                                <h3 id="fabric-name">Denim</h3>
                                <div id="fabric-type">Textured Material</div>
                            </div>
                        </div>

                        <div class="normal-map-preview" id="normal-map-container" style="display:none;">
                            <h4>Normal Map Visualization</h4>
                            <img src="" alt="Normal Map" class="normal-map-img" id="normal-map-img">
                            <p class="mt-2"><small>This visualization shows the texture depth map used for 3D rendering</small></p>
                        </div>

                        <h4 class="mt-3">Material Properties</h4>
                        <table class="material-properties-table">
                            <tr>
                                <th>Property</th>
                                <th>Value</th>
                                <th>Visual Effect</th>
                            </tr>
                            <tr>
                                <td>Texture Complexity</td>
                                <td id="texture-complexity-value">150.00</td>
                                <td>Determines fabric detail level</td>
                            </tr>
                            <tr>
                                <td>Edge Density</td>
                                <td id="edge-density-value">0.0230</td>
                                <td>Affects fabric roughness</td>
                            </tr>
                            <tr>
                                <td>Pattern Strength</td>
                                <td id="pattern-strength-value">60%</td>
                                <td>Controls pattern visibility</td>
                            </tr>
                        </table>

                        <h4 class="mt-3">Fabric Characteristics</h4>
                        <div class="fabric-characteristics" id="fabric-characteristics">
                            <span class="fabric-characteristic">Durable</span>
                            <span class="fabric-characteristic">Heavy weight</span>
                            <span class="fabric-characteristic">Textured surface</span>
                        </div>
                    </div>
                </div>

                <div class="col-md-4">
                    <div class="viewer-controls">
                        <h3>Select Clothing Item</h3>

                        <div class="form-group mb-3">
                            <label for="item-select">Choose a wardrobe item:</label>
                            <select id="item-select" class="form-control">
                                <option value="">-- Select an item --</option>
                                {% for item in items %}
                                    <option value="{{ item._id }}">{{ item.label }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div id="material-preview" class="material-preview" style="display: none;">
                            <!-- Material preview will be populated here -->
                        </div>

                        <div class="tab-nav">
                            <button class="tab-button active" data-tab="material-tab">Material</button>
                            <button class="tab-button" data-tab="pattern-tab">Pattern</button>
                            <button class="tab-button" data-tab="model-tab">3D Model</button>
                        </div>

                        <div id="material-tab" class="tab-panel active">
                            <div class="material-settings">
                                <div class="setting-group">
                                    <label class="setting-label">Roughness: <span id="roughness-value" class="slider-value">0.5</span></label>
                                    <div class="slider-container">
                                        <input type="range" id="roughness-slider" class="slider" min="0" max="1" step="0.01" value="0.5">
                                    </div>
                                </div>

                                <div class="setting-group">
                                    <label class="setting-label">Metalness: <span id="metalness-value" class="slider-value">0.1</span></label>
                                    <div class="slider-container">
                                        <input type="range" id="metalness-slider" class="slider" min="0" max="1" step="0.01" value="0.1">
                                    </div>
                                </div>

                                <div class="setting-group">
                                    <label class="setting-label">Color Intensity: <span id="color-intensity-value" class="slider-value">1.0</span></label>
                                    <div class="slider-container">
                                        <input type="range" id="color-intensity-slider" class="slider" min="0" max="2" step="0.01" value="1.0">
                                    </div>
                                </div>

                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" id="use-color-checkbox" checked>
                                    <label class="form-check-label" for="use-color-checkbox">
                                        Apply material color (uncheck for exact texture colors)
                                    </label>
                                </div>
                            </div>
                        </div>

                        <div id="pattern-tab" class="tab-panel">
                            <div class="material-settings">
                                <div class="setting-group">
                                    <label class="setting-label">Pattern Scale: <span id="pattern-scale-value" class="slider-value">1.0</span></label>
                                    <div class="slider-container">
                                        <input type="range" id="pattern-scale-slider" class="slider" min="0.1" max="5" step="0.1" value="1.0">
                                    </div>
                                </div>

                                <div class="setting-group">
                                    <label class="setting-label">Pattern Rotation: <span id="pattern-rotation-value" class="slider-value">0°</span></label>
                                    <div class="slider-container">
                                        <input type="range" id="pattern-rotation-slider" class="slider" min="0" max="360" step="1" value="0">
                                    </div>
                                </div>

                                <div class="setting-group">
                                    <label class="setting-label">Normal Map Strength: <span id="normal-strength-value" class="slider-value">1.0</span></label>
                                    <div class="slider-container">
                                        <input type="range" id="normal-strength-slider" class="slider" min="0" max="3" step="0.1" value="1.0">
                                    </div>
                                </div>

                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" id="use-normal-map-checkbox" checked>
                                    <label class="form-check-label" for="use-normal-map-checkbox">
                                        Use normal map (texture relief)
                                    </label>
                                </div>
                            </div>
                        </div>

                        <div id="model-tab" class="tab-panel">
                            <div class="material-settings">
                                <div class="form-group mb-3">
                                    <label for="model-select">Choose a 3D model:</label>
                                    <select id="model-select" class="form-control">
                                        <option value="sphere">Sphere</option>
                                        <option value="cube">Cube</option>
                                        <option value="torus">Torus</option>
                                        <option value="cylinder">Cylinder</option>
                                        <option value="tshirt" selected>T-shirt</option>
                                        <option value="dress">Dress</option>
                                        <option value="pants">Pants</option>
                                    </select>
                                </div>

                                <div class="form-group mb-3">
                                    <label for="model-upload">Or upload your own GLB model:</label>
                                    <input type="file" id="model-upload" class="form-control" accept=".glb,.gltf">
                                </div>
                            </div>
                        </div>

                        <button id="update-material-btn" class="btn btn-primary mt-3">Update Material</button>

                        <!-- Fabric Sample Swatches -->
                        <div class="card mt-4">
                            <div class="card-header">
                                <h3 class="mb-0">Similar Fabric Samples</h3>
                            </div>
                            <div class="card-body">
                                <p>Compare with similar fabric types:</p>
                                <div class="fabric-swatch-container" id="fabric-swatches">
                                    <!-- Fabric swatches will be added here -->
                                </div>
                                <div class="mt-3">
                                    <button id="apply-selected-fabric-btn" class="btn btn-secondary">
                                        Apply Selected Fabric
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Error toast -->
<div id="error-toast"></div>

<!-- Texture preview container (initially hidden) -->
<div class="texture-preview-container" style="display: none;">
    <h3>Texture Preview</h3>
    <div class="texture-preview">
        <div class="texture-images">
            <div class="texture-image-container">
                <h4>Diffuse Texture</h4>
                <img id="diffuse-texture" class="texture-image" src="" alt="Diffuse Texture">
            </div>
            <div class="texture-image-container">
                <h4>Normal Map</h4>
                <img id="normal-map" class="texture-image" src="" alt="Normal Map">
            </div>
        </div>
        <div class="texture-controls">
            <div class="texture-properties">
                <div class="texture-property">
                    <label for="roughness">Roughness</label>
                    <input type="range" id="roughness" min="0" max="1" step="0.1" value="0.7">
                    <span class="value">0.7</span>
                </div>
                <div class="texture-property">
                    <label for="metalness">Metalness</label>
                    <input type="range" id="metalness" min="0" max="1" step="0.1" value="0.1">
                    <span class="value">0.1</span>
                </div>
                <div>
                <div id="texture-debug-container"></div>
                <button id="debug-texture-btn" class="btn btn-info mt-2">Debug Texture</button>
                    </div>

            </div>
            <div class="texture-actions">
                <button class="save-btn" id="save-texture">Save Texture</button>
                <button class="reset-btn" id="reset-texture">Reset</button>
            </div>
        </div>
    </div>
</div>

<!-- Improved result template with sections and fabric type -->
<template id="improved-result-template">
  <div class="prediction-result">
    <!-- Top row for basic clothing info -->
    <div class="result-section">
      <div class="result-row">
        <div class="result-label">Clothing Type:</div>
        <div class="result-value" id="result-type">Trouser</div>
      </div>
      <div class="result-row">
        <div class="result-label">Fabric Type:</div>
        <div class="result-value" id="result-fabric">Denim</div>
      </div>
    </div>

    <!-- Color information -->
    <div class="result-section">
      <h3>Dominant Color</h3>
      <div class="result-row">
        <div class="color-preview" id="color-preview" style="background-color: rgb(64, 97, 156);"></div>
        <div class="color-info">
          <div id="result-color">RGB: 64, 97, 156</div>
          <div id="result-percentage">Percentage: 42.0%</div>
        </div>
      </div>
    </div>

    <!-- Material analysis -->
    <div class="result-section">
      <h3>Material Analysis</h3>
      <div class="result-row">
        <div class="result-label">Material Type:</div>
        <div class="result-value" id="material-type">textured</div>
      </div>
      <div class="result-row">
        <div class="result-label">Texture Complexity:</div>
        <div class="result-value" id="texture-variance">150.00</div>
      </div>
      <div class="result-row">
        <div class="result-label">Edge Density:</div>
        <div class="result-value" id="edge-density">0.0230</div>
      </div>
    </div>

    <!-- Pattern information -->
    <div class="result-section">
      <h3>Pattern Information</h3>
      <div class="result-row">
        <div class="result-label">Pattern Type:</div>
        <div class="result-value">
          <span class="pattern-badge" id="pattern-type">vertical stripe</span>
        </div>
      </div>
      <div class="result-row">
        <div class="result-label">Pattern Strength:</div>
        <div class="result-value" id="pattern-strength">60%</div>
      </div>
      <div class="result-row">
        <div class="result-label">Texture Preview:</div>
        <div class="result-value">
          <img id="texture-preview" class="texture-preview-image" src="" alt="Texture Preview">
        </div>
      </div>
    </div>

    <div class="action-buttons">
      <button onclick="location.reload()" class="btn btn-secondary">Add Another Item</button>
      <button id="view-in-3d-btn" class="btn btn-primary">View in 3D</button>
      <button id="analyze-material-btn" class="btn btn-info">Advanced Material Analysis</button>
      <button id="debug-color-btn" class="btn btn-info">Debug Color</button>
    </div>
  </div>
</template>
{% endblock %}

{% block extra_js %}
<!-- Include Three.js libraries directly -->
<script src="https://cdn.jsdelivr.net/npm/three@0.150.1/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.150.1/examples/js/controls/OrbitControls.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.150.1/examples/js/loaders/GLTFLoader.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.150.1/examples/js/loaders/DRACOLoader.js"></script>

<!-- Add Font Awesome for icons -->
<script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>

<!-- Custom scripts -->
<script>
/**
 * EnhancedFabricViewer - A comprehensive system for visualizing fabric materials in 3D
 * This class connects fabric type identification with 3D rendering
 */
class EnhancedFabricViewer {
  constructor(canvasContainer) {
    // Initialize properties
    this.container = canvasContainer;
    this.scene = null;
    this.camera = null;
    this.renderer = null;
    this.controls = null;
    this.currentModel = null;
    this.currentLights = [];
    this.currentMaterial = null;
    this.isInitialized = false;
    this.loadingManager = new THREE.LoadingManager();
    this.textureLoader = new THREE.TextureLoader(this.loadingManager);

    // Setup GLTFLoader
    this.gltfLoader = new THREE.GLTFLoader(this.loadingManager);

    // Setup loading manager events
    this.setupLoadingManager();

    // Initialize the viewer
    this.init();

    // Handle window resize
    window.addEventListener('resize', () => this.onWindowResize());
  }

  /**
   * Setup loading manager callbacks
   */
  setupLoadingManager() {
    this.loadingManager.onStart = (url, itemsLoaded, itemsTotal) => {
      this.showLoading(`Loading resources... (${itemsLoaded}/${itemsTotal})`);
    };

    this.loadingManager.onProgress = (url, itemsLoaded, itemsTotal) => {
      this.updateLoading(`Loading resources... (${itemsLoaded}/${itemsTotal})`);
    };

    this.loadingManager.onLoad = () => {
      this.hideLoading();
    };

    this.loadingManager.onError = (url) => {
      console.error('Error loading resource:', url);
      this.showError(`Error loading resource: ${url}`);
      this.hideLoading();
    };
  }

  /**
   * Initialize the 3D renderer
   */
  init() {
    if (this.isInitialized) return;

    // Create scene
    this.scene = new THREE.Scene();
    this.scene.background = new THREE.Color(0xf5f5f5);

    // Create camera
    this.camera = new THREE.PerspectiveCamera(
      45, this.container.clientWidth / this.container.clientHeight, 0.1, 1000
    );
    this.camera.position.set(0, 0, 4);

    // Create renderer
    this.renderer = new THREE.WebGLRenderer({
      antialias: true,
      alpha: true
    });
    this.renderer.setSize(this.container.clientWidth, this.container.clientHeight);
    this.renderer.setPixelRatio(window.devicePixelRatio);
    this.renderer.shadowMap.enabled = true;
    this.renderer.shadowMap.type = THREE.PCFSoftShadowMap;
    this.renderer.outputEncoding = THREE.sRGBEncoding;
    this.renderer.toneMapping = THREE.ACESFilmicToneMapping;
    this.renderer.toneMappingExposure = 1.0;

    // Add the renderer to the container
    this.container.appendChild(this.renderer.domElement);

    // Create orbit controls
    this.controls = new THREE.OrbitControls(this.camera, this.renderer.domElement);
    this.controls.enableDamping = true;
    this.controls.dampingFactor = 0.05;
    this.controls.minDistance = 1.5;
    this.controls.maxDistance = 10;

    // Add standard lights
    this.setLightingMode('standard');

    // Start the animation loop
    this.animate();

    this.isInitialized = true;
  }

  /**
   * Set up different lighting modes for the scene
   */
  setLightingMode(mode) {
    // Remove existing lights
    this.currentLights.forEach(light => {
      this.scene.remove(light);
    });
    this.currentLights = [];

    switch(mode) {
      case 'standard':
        // Simple three-point lighting
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.4);
        this.scene.add(ambientLight);
        this.currentLights.push(ambientLight);

        const mainLight = new THREE.DirectionalLight(0xffffff, 0.6);
        mainLight.position.set(5, 5, 5);
        mainLight.castShadow = true;
        mainLight.shadow.mapSize.width = 1024;
        mainLight.shadow.mapSize.height = 1024;
        this.scene.add(mainLight);
        this.currentLights.push(mainLight);

        const fillLight = new THREE.DirectionalLight(0xffffff, 0.3);
        fillLight.position.set(-5, 2, -5);
        this.scene.add(fillLight);
        this.currentLights.push(fillLight);
        break;

      case 'fabric':
        // Enhanced lighting for fabric detail
        const fabricAmbient = new THREE.AmbientLight(0xffffff, 0.2);
        this.scene.add(fabricAmbient);
        this.currentLights.push(fabricAmbient);

        // Strong overhead light to cast shadows
        const topLight = new THREE.DirectionalLight(0xffffff, 0.8);
        topLight.position.set(0, 10, 0);
        topLight.castShadow = true;
        this.scene.add(topLight);
        this.currentLights.push(topLight);

        // Rim light to highlight edges
        const rimLight = new THREE.DirectionalLight(0xffffdd, 0.6);
        rimLight.position.set(0, 0, 10);
        this.scene.add(rimLight);
        this.currentLights.push(rimLight);

        // Front light for visibility
        const frontLight = new THREE.DirectionalLight(0xffffff, 0.4);
        frontLight.position.set(0, 0, 5);
        this.scene.add(frontLight);
        this.currentLights.push(frontLight);
        break;

      case 'realistic':
        // Studio-like lighting for realistic showcase
        const studioAmbient = new THREE.AmbientLight(0xffffff, 0.3);
        this.scene.add(studioAmbient);
        this.currentLights.push(studioAmbient);

        // Main key light
        const keyLight = new THREE.DirectionalLight(0xffffff, 1.0);
        keyLight.position.set(5, 8, 10);
        keyLight.castShadow = true;
        keyLight.shadow.mapSize.width = 2048;
        keyLight.shadow.mapSize.height = 2048;
        this.scene.add(keyLight);
        this.currentLights.push(keyLight);

        // Softer fill light
        const softFill = new THREE.DirectionalLight(0xfffbf0, 0.5);
        softFill.position.set(-5, 3, 0);
        this.scene.add(softFill);
        this.currentLights.push(softFill);

        // Subtle back light for rim highlighting
        const backLight = new THREE.DirectionalLight(0xe0e0ff, 0.4);
        backLight.position.set(0, 5, -10);
        this.scene.add(backLight);
        this.currentLights.push(backLight);

        // Ground bounce light
        const bounceLight = new THREE.DirectionalLight(0xfffff0, 0.2);
        bounceLight.position.set(0, -5, 0);
        this.scene.add(bounceLight);
        this.currentLights.push(bounceLight);
        break;
    }

    this.viewMode = mode;
  }

  /**
   * Animation loop
   */
  animate() {
    requestAnimationFrame(() => this.animate());

    if (this.controls) {
      this.controls.update();
    }

    this.render();
  }

  /**
   * Render the scene
   */
  render() {
    if (this.renderer && this.scene && this.camera) {
      this.renderer.render(this.scene, this.camera);
    }
  }

  /**
   * Handle window resize
   */
  onWindowResize() {
    if (this.camera && this.renderer) {
      this.camera.aspect = this.container.clientWidth / this.container.clientHeight;
      this.camera.updateProjectionMatrix();
      this.renderer.setSize(this.container.clientWidth, this.container.clientHeight);
    }
  }

  /**
   * Load a 3D model
   */
  loadModel(modelPath) {
    return new Promise((resolve, reject) => {
      this.showLoading('Loading 3D model...');

      // Clean previous model if any
      if (this.currentModel) {
        this.scene.remove(this.currentModel);
        this.currentModel = null;
      }

      this.gltfLoader.load(
        modelPath,
        (gltf) => {
          const model = gltf.scene;

          // Setup the model
          model.traverse((node) => {
            if (node.isMesh) {
              // Store original material
              node.userData.originalMaterial = node.material;

              // Enable shadows
              node.castShadow = true;
              node.receiveShadow = true;
            }
          });

          // Center the model
          const box = new THREE.Box3().setFromObject(model);
          const center = box.getCenter(new THREE.Vector3());
          model.position.x = -center.x;
          model.position.y = -center.y;
          model.position.z = -center.z;

          // Scale the model to fit view
          const size = box.getSize(new THREE.Vector3());
          const maxDim = Math.max(size.x, size.y, size.z);
          const scale = 3 / maxDim;
          model.scale.set(scale, scale, scale);

          // Add to scene
          this.scene.add(model);
          this.currentModel = model;

          // Position camera to see the model
          this.camera.position.set(0, 0, 4);
          this.controls.target.set(0, 0, 0);
          this.controls.update();

          this.hideLoading();
          resolve(model);
        },
        (xhr) => {
          const percent = Math.floor((xhr.loaded / xhr.total) * 100);
          this.updateLoading(`Loading 3D model... ${percent}%`);
        },
        (error) => {
          console.error('Error loading model:', error);
          this.hideLoading();
          this.showError('Error loading 3D model. Please try again.');
          reject(error);
        }
      );
    });
  }

  /**
   * Get material parameters from material analysis data
   */
  getMaterialParameters(materialProperties) {
    // Default parameters for unknown materials
    const defaults = {
      roughness: 0.5,
      metalness: 0.1,
      normalStrength: 1.0,
      textureScale: 1.0,
      colorIntensity: 1.0
    };

    if (!materialProperties) return defaults;

    const materialType = materialProperties.estimated_material || 'medium';
    const edgeDensity = materialProperties.edge_density || 0.1;
    const textureVariance = materialProperties.texture_variance || 100;

    // Material-specific parameters
    const materialMappings = {
      'smooth': {
        roughness: 0.3,
        metalness: 0.15,
        normalStrength: 0.3,
        textureScale: 0.8,
        colorIntensity: 1.2
      },
      'textured': {
        roughness: 0.7,
        metalness: 0.05,
        normalStrength: 1.2,
        textureScale: 1.2,
        colorIntensity: 0.9
      },
      'rough_textured': {
        roughness: 0.9,
        metalness: 0.0,
        normalStrength: 2.0,
        textureScale: 1.5,
        colorIntensity: 0.8
      },
      'patterned': {
        roughness: 0.6,
        metalness: 0.05,
        normalStrength: 0.8,
        textureScale: 1.0,
        colorIntensity: 1.0
      },
      'medium': defaults
    };

    // Get base parameters from material type
    const params = Object.assign({}, materialMappings[materialType] || defaults);

    // Fine-tune based on measured properties
    if (edgeDensity > 0.3) {
      params.roughness = Math.min(1.0, params.roughness + 0.2);
      params.normalStrength += 0.5;
    } else if (edgeDensity < 0.05) {
      params.roughness = Math.max(0.1, params.roughness - 0.2);
    }

    if (textureVariance > 200) {
      params.textureScale = 1.5;  // Scale up high-variance textures
      params.normalStrength *= 1.3;
    } else if (textureVariance < 50) {
      params.normalStrength *= 0.7;
    }

    // Handle pattern information if available
    if (materialProperties.pattern_info) {
      const pattern = materialProperties.pattern_info;

      // Enhance normal map for stronger patterns
      if (pattern.pattern_strength > 0.5) {
        params.normalStrength = Math.min(3.0, params.normalStrength * 1.5);
      }

      // Scale texture based on pattern scale
      if (pattern.pattern_scale === 'fine') {
        params.textureScale = 2.0;
      } else if (pattern.pattern_scale === 'large') {
        params.textureScale = 0.7;
      }
    }

    return params;
  }

  /**
   * Apply texture and material properties to the 3D model
   */
  applyMaterial(model, texturePath, materialProperties, normalMapPath = null) {
    return new Promise((resolve, reject) => {
      if (!model || !texturePath) {
        this.showError('Missing model or texture');
        reject(new Error('Missing model or texture'));
        return;
      }

      this.showLoading('Applying material...');

      // Get material parameters based on analysis
      const params = this.getMaterialParameters(materialProperties);

      // Load the texture
      this.textureLoader.load(
        texturePath,
        (texture) => {
          // Configure texture
          texture.encoding = THREE.sRGBEncoding;
          texture.wrapS = THREE.RepeatWrapping;
          texture.wrapT = THREE.RepeatWrapping;
          texture.repeat.set(params.textureScale, params.textureScale);

          // Create a promise chain for texture loading
          let normalMapPromise = Promise.resolve(null);

          // Load normal map if provided
          if (normalMapPath) {
            normalMapPromise = new Promise((resolveNormal) => {
              this.textureLoader.load(
                normalMapPath,
                (normalMap) => {
                  normalMap.wrapS = THREE.RepeatWrapping;
                  normalMap.wrapT = THREE.RepeatWrapping;
                  normalMap.repeat.copy(texture.repeat);
                  resolveNormal(normalMap);
                },
                undefined,
                () => {
                  console.warn('Error loading normal map');
                  resolveNormal(null);
                }
              );
            });
          }

          // Apply textures when loaded
          normalMapPromise.then((normalMap) => {
            // Create material
            const material = new THREE.MeshStandardMaterial({
              map: texture,
              normalMap: normalMap,
              normalScale: new THREE.Vector2(params.normalStrength, params.normalStrength),
              roughness: params.roughness,
              metalness: params.metalness,
              side: THREE.DoubleSide,
              transparent: true
            });

            // Apply color tint if color information available
            if (materialProperties && materialProperties.primary_color_rgb) {
              let colorArray = materialProperties.primary_color_rgb;

              // Create THREE.Color (uses RGB order)
              const color = new THREE.Color(
                colorArray[0] / 255.0,
                colorArray[1] / 255.0,
                colorArray[2] / 255.0
              );

              // Apply color intensity
              if (params.colorIntensity !== 1.0) {
                const hsl = {};
                color.getHSL(hsl);
                hsl.l = Math.min(1, hsl.l * params.colorIntensity);
                color.setHSL(hsl.h, hsl.s, hsl.l);
              }

              material.color = color;
            }

            // Store current material
            this.currentMaterial = material;

            // Apply material to model
            model.traverse((node) => {
              if (node.isMesh) {
                node.material = material;
              }
            });

            // Update UI with normal map if available
            this.updateNormalMapDisplay(normalMapPath);

            this.hideLoading();
            resolve(true);
          });
        },
        (xhr) => {
          const percent = Math.floor((xhr.loaded / xhr.total) * 100);
          this.updateLoading(`Loading texture... ${percent}%`);
        },
        (error) => {
          console.error('Error loading texture:', error);
          this.hideLoading();
          this.showError('Error loading texture');
          reject(error);
        }
      );
    });
  }

  /**
   * Update the normal map display in the UI
   */
  updateNormalMapDisplay(normalMapPath) {
    const container = document.getElementById('normal-map-container');
    const img = document.getElementById('normal-map-img');

    if (container && img) {
      if (normalMapPath) {
        img.src = normalMapPath;
        container.style.display = 'block';
      } else {
        container.style.display = 'none';
      }
    }
  }

  /**
   * Update material properties in real-time
   */
  updateMaterialProperties(properties) {
    if (!this.currentModel || !this.currentMaterial) return;

    // Apply properties to the current material
    if (properties.roughness !== undefined) {
      this.currentMaterial.roughness = properties.roughness;
    }

    if (properties.metalness !== undefined) {
      this.currentMaterial.metalness = properties.metalness;
    }

    if (properties.normalScale !== undefined && this.currentMaterial.normalMap) {
      this.currentMaterial.normalScale.set(properties.normalScale, properties.normalScale);
    }

    if (properties.textureScale !== undefined && this.currentMaterial.map) {
      this.currentMaterial.map.repeat.set(properties.textureScale, properties.textureScale);

      if (this.currentMaterial.normalMap) {
        this.currentMaterial.normalMap.repeat.copy(this.currentMaterial.map.repeat);
      }
    }

    // Mark textures for update
    if (this.currentMaterial.map) {
      this.currentMaterial.map.needsUpdate = true;
    }

    if (this.currentMaterial.normalMap) {
      this.currentMaterial.normalMap.needsUpdate = true;
    }

    // Mark material for update
    this.currentMaterial.needsUpdate = true;
  }

  /**
   * Generate fabric characteristic descriptions based on material properties
   */
  generateFabricCharacteristics(materialProperties) {
    if (!materialProperties) return [];

    const characteristics = [];
    const materialType = materialProperties.estimated_material || 'medium';
    const textureVariance = materialProperties.texture_variance || 100;
    const edgeDensity = materialProperties.edge_density || 0.1;

    // Material-specific characteristics
    const materialCharacteristics = {
      'smooth': ['Smooth surface', 'Low texture', 'Soft hand feel'],
      'textured': ['Textured surface', 'Medium weight', 'Durable'],
      'rough_textured': ['Heavy texture', 'Sturdy', 'Coarse hand feel'],
      'patterned': ['Distinct pattern', 'Visual texture', 'Decorative'],
      'medium': ['Medium texture', 'Balanced weight', 'Versatile']
    };

    // Add base characteristics for material type
    characteristics.push(...(materialCharacteristics[materialType] || []));

    // Add characteristics based on measured properties
    if (textureVariance > 200) {
      characteristics.push('High contrast texture');
    } else if (textureVariance < 50) {
      characteristics.push('Uniform appearance');
    }

    if (edgeDensity > 0.3) {
      characteristics.push('Complex surface structure');
    } else if (edgeDensity < 0.05) {
      characteristics.push('Minimal surface detail');
    }

    // Add pattern characteristics if available
    if (materialProperties.pattern_info) {
      const pattern = materialProperties.pattern_info;

      if (pattern.pattern_type) {
        characteristics.push(`${pattern.pattern_type.replace('_', ' ')} pattern`);
      }

      if (pattern.pattern_scale) {
        characteristics.push(`${pattern.pattern_scale} pattern scale`);
      }

      if (pattern.is_directional) {
        characteristics.push('Directional pattern');
      }
    }

    // Return unique characteristics
    return [...new Set(characteristics)];
  }

  /**
   * Update fabric info panel with material properties
   */
  updateFabricInfoPanel(itemData) {
    const fabricNameEl = document.getElementById('fabric-name');
    const fabricTypeEl = document.getElementById('fabric-type');
    const fabricSampleEl = document.getElementById('fabric-sample');
    const textureComplexityEl = document.getElementById('texture-complexity-value');
    const edgeDensityEl = document.getElementById('edge-density-value');
    const patternStrengthEl = document.getElementById('pattern-strength-value');
    const fabricCharacteristicsEl = document.getElementById('fabric-characteristics');
    const fabricInfoPanel = document.getElementById('fabric-info-panel');

    if (!fabricInfoPanel || !itemData) return;

    // Show the panel
    fabricInfoPanel.style.display = 'block';

    // Get material properties
    const materialProperties = itemData.material_properties || {};
    const fabricType = getFabricType(itemData.label, materialProperties);

    // Update elements
    if (fabricNameEl) fabricNameEl.textContent = `${itemData.label} - ${fabricType}`;
    if (fabricTypeEl) fabricTypeEl.textContent = `${materialProperties.estimated_material || 'Unknown'} material`;
    if (fabricSampleEl) fabricSampleEl.style.backgroundImage = `url('${itemData.file_path}')`;
    if (textureComplexityEl) textureComplexityEl.textContent = materialProperties.texture_variance ?
      materialProperties.texture_variance.toFixed(2) : '0.00';
    if (edgeDensityEl) edgeDensityEl.textContent = materialProperties.edge_density ?
      materialProperties.edge_density.toFixed(4) : '0.0000';

    // Update pattern strength
    let patternStrength = 0;
    if (materialProperties.pattern_info && materialProperties.pattern_info.pattern_strength) {
      patternStrength = materialProperties.pattern_info.pattern_strength;
    }
    if (patternStrengthEl) patternStrengthEl.textContent = `${(patternStrength * 100).toFixed(0)}%`;

    // Generate and update fabric characteristics
    if (fabricCharacteristicsEl) {
      const characteristics = this.generateFabricCharacteristics(materialProperties);
      fabricCharacteristicsEl.innerHTML = characteristics.map(
        char => `<span class="fabric-characteristic">${char}</span>`
      ).join('');
    }
  }

  /**
   * Load and visualize a clothing item
   */
  loadClothingItem(itemData) {
    if (!itemData) return Promise.reject(new Error('No item data provided'));

    // Determine appropriate model path
    const modelType = getModelForClothingType(itemData.label);
    const modelPath = `/static/models/clothing/${modelType}.glb`;

    // Update fabric info panel
    this.updateFabricInfoPanel(itemData);

    // Generate fabric swatches
    this.generateFabricSwatches(itemData);

    // Load model and apply material
    return this.loadModel(modelPath)
      .then(model => {
        return this.applyMaterial(
          model,
          itemData.file_path,
          itemData.material_properties,
          itemData.normal_map_path
        );
      });
  }

  /**
   * Generate similar fabric swatches
   */
  generateFabricSwatches(itemData) {
    const swatchContainer = document.getElementById('fabric-swatches');
    if (!swatchContainer || !itemData) return;

    // Clear existing swatches
    swatchContainer.innerHTML = '';

    // Get material type
    const materialType = itemData.material_properties?.estimated_material || 'medium';

    // Define sample swatches for each material type
    const fabricSwatches = {
      'smooth': [
        { name: 'Silk', img: '/static/img/fabrics/silk.jpg' },
        { name: 'Satin', img: '/static/img/fabrics/satin.jpg' },
        { name: 'Leather', img: '/static/img/fabrics/leather.jpg' }
      ],
      'textured': [
        { name: 'Denim', img: '/static/img/fabrics/denim.jpg' },
        { name: 'Canvas', img: '/static/img/fabrics/canvas.jpg' },
        { name: 'Twill', img: '/static/img/fabrics/twill.jpg' }
      ],
      'rough_textured': [
        { name: 'Tweed', img: '/static/img/fabrics/tweed.jpg' },
        { name: 'Wool', img: '/static/img/fabrics/wool.jpg' },
        { name: 'Burlap', img: '/static/img/fabrics/burlap.jpg' }
      ],
      'patterned': [
        { name: 'Printed Cotton', img: '/static/img/fabrics/printed_cotton.jpg' },
        { name: 'Jacquard', img: '/static/img/fabrics/jacquard.jpg' },
        { name: 'Brocade', img: '/static/img/fabrics/brocade.jpg' }
      ],
      'medium': [
        { name: 'Cotton', img: '/static/img/fabrics/cotton.jpg' },
        { name: 'Linen', img: '/static/img/fabrics/linen.jpg' },
        { name: 'Polyester', img: '/static/img/fabrics/polyester.jpg' }
      ]
    };

    // Use default fallback if material type not found
    const swatches = fabricSwatches[materialType] || fabricSwatches['medium'];

    // Add current item's texture as first swatch
    swatches.unshift({
      name: 'Current Fabric',
      img: itemData.file_path
    });

    // Create swatch elements
    swatches.forEach((swatch, index) => {
      const swatchEl = document.createElement('div');
      swatchEl.className = 'fabric-swatch';
      if (index === 0) swatchEl.classList.add('selected');
      swatchEl.style.backgroundImage = `url('${swatch.img}')`;
      swatchEl.title = swatch.name;
      swatchEl.dataset.fabricImg = swatch.img;

      // Add click handler
      swatchEl.addEventListener('click', () => {
        // Update selection
        document.querySelectorAll('.fabric-swatch').forEach(el => {
          el.classList.remove('selected');
        });
        swatchEl.classList.add('selected');
      });

      swatchContainer.appendChild(swatchEl);
    });
  }

  /**
   * UI Helper: Show loading overlay
   */
  showLoading(message = 'Loading...') {
    const loadingOverlay = document.getElementById('loading-overlay');
    const loadingText = document.getElementById('loading-text');

    if (loadingOverlay) {
      loadingOverlay.classList.add('visible');
    }

    if (loadingText) {
      loadingText.textContent = message;
    }
  }

  /**
   * UI Helper: Update loading message
   */
  updateLoading(message) {
    const loadingText = document.getElementById('loading-text');
    if (loadingText) {
      loadingText.textContent = message;
    }
  }

  /**
   * UI Helper: Hide loading overlay
   */
  hideLoading() {
    const loadingOverlay = document.getElementById('loading-overlay');
    if (loadingOverlay) {
      loadingOverlay.classList.remove('visible');
    }
  }

  /**
   * UI Helper: Show error toast
   */
  showError(message) {
    const errorToast = document.getElementById('error-toast');

    if (!errorToast) {
      const toast = document.createElement('div');
      toast.id = 'error-toast';
      toast.style.position = 'fixed';
      toast.style.bottom = '20px';
      toast.style.right = '20px';
      toast.style.backgroundColor = '#f44336';
      toast.style.color = 'white';
      toast.style.padding = '15px';
      toast.style.borderRadius = '4px';
      toast.style.zIndex = '1000';
      toast.style.transition = 'opacity 0.5s';
      toast.style.opacity = '0';
      document.body.appendChild(toast);
    }

    const toast = document.getElementById('error-toast');
    toast.textContent = message;
    toast.style.opacity = '1';

    setTimeout(() => {
      toast.style.opacity = '0';
    }, 5000);
  }
}

/**
 * Helper: Get fabric type from material properties and clothing label
 */
function getFabricType(clothingType, materialProps) {
  if (materialProps?.estimated_material) {
    const materialMap = {
      'smooth': 'Silk',
     'textured': 'Denim',
      'rough_textured': 'Tweed',
      'patterned': 'Printed Fabric',
      'medium': 'Cotton'
    };
    return materialMap[materialProps.estimated_material] || 'Fabric';
  }

  // Fallback to typical fabrics based on clothing type
  const clothingFabricMap = {
    'T-shirt/top': 'Cotton',
    'Trouser': 'Denim',
    'Pullover': 'Wool',
    'Dress': 'Polyester',
    'Coat': 'Wool Blend',
    'Sandal': 'Leather',
    'Shirt': 'Cotton',
    'Sneaker': 'Canvas',
    'Bag': 'Leather',
    'Ankle boot': 'Leather'
  };
  return clothingFabricMap[clothingType] || 'Fabric';
}

/**
 * Helper: Get 3D model type for clothing type
 */
function getModelForClothingType(clothingType) {
  const modelMap = {
    'T-shirt/top': 'tshirt',
    'Shirt': 'tshirt',
    'Trouser': 'pants',
    'Pullover': 'pullover',
    'Dress': 'dress',
    'Coat': 'coat',
    'Sandal': 'sandal',
    'Sneaker': 'sneaker',
    'Bag': 'bag',
    'Ankle boot': 'boot'
  };

  return modelMap[clothingType] || 'tshirt';
}

/**
 * Debug Color Detection - Request the debug visualization from the server
 */
function debugColorDetection(itemId) {
    // Show a loading message
    const debugPanel = document.getElementById('color-debug-panel');
    const debugContainer = document.getElementById('debug-image-container');

    if (!debugPanel || !debugContainer) return;

    debugPanel.style.display = 'block';
    debugContainer.innerHTML = '<div class="loader"></div><p>Generating color analysis visualization...</p>';

    // Request debug visualization
    fetch(`/api/debug-color-detection/${itemId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.debug_image_url) {
                const img = document.createElement('img');
                img.src = data.debug_image_url;
                img.className = 'debug-image';
                img.alt = 'Color Analysis Debug';

                debugContainer.innerHTML = '';
                debugContainer.appendChild(img);
                debugContainer.style.display = 'block';
            } else {
                debugContainer.innerHTML = '<p>Error generating color analysis visualization.</p>';
            }
        })
        .catch(error => {
            console.error('Error:', error);
            debugContainer.innerHTML = '<p>Error requesting color analysis debug.</p>';
        });
}

/**
 * Advanced Material Analysis
 * Makes a request to the API to analyze material in detail
 */
function analyzeMaterial(file) {
    return new Promise((resolve, reject) => {
        // Create form data with the file
        const formData = new FormData();
        formData.append('file', file);

        // Make API request
        fetch('/api/wardrobe/analyze-material', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Show the material analysis section
                document.getElementById('material-analysis-section').style.display = 'block';

                // Update UI with material analysis data
                updateMaterialAnalysisUI(data.materialAnalysis);
                resolve(data.materialAnalysis);
            } else {
                reject(new Error(data.error || 'Failed to analyze material'));
            }
        })
        .catch(error => {
            console.error('Error analyzing material:', error);
            reject(error);
        });
    });
}

/**
 * Update Material Analysis UI with advanced material properties
 */
function updateMaterialAnalysisUI(materialData) {
    if (!materialData) return;

    const container = document.getElementById('material-analysis-container');
    if (!container) return;

    // Update material type
    const materialTypeElement = document.getElementById('material-type-result');
    if (materialTypeElement) {
        materialTypeElement.textContent = materialData.material_type.charAt(0).toUpperCase() +
                                          materialData.material_type.slice(1);
    }

    // Update confidence
    const confidenceElement = document.getElementById('material-confidence');
    if (confidenceElement) {
        confidenceElement.textContent = `${materialData.confidence}% confidence`;

        // Color the badge based on confidence
        if (materialData.confidence > 80) {
            confidenceElement.style.backgroundColor = '#28a745'; // Green for high confidence
        } else if (materialData.confidence > 50) {
            confidenceElement.style.backgroundColor = '#ffc107'; // Yellow for medium
        } else {
            confidenceElement.style.backgroundColor = '#dc3545'; // Red for low
        }
    }

    // Update alternative materials
    const alternativesElement = document.getElementById('alternative-materials');
    if (alternativesElement && materialData.alternative_materials) {
        alternativesElement.innerHTML = '';

        materialData.alternative_materials.forEach(alt => {
            const altElement = document.createElement('span');
            altElement.className = 'alternative-material';
            altElement.innerHTML = `${alt.material} <span class="confidence">${alt.confidence}%</span>`;
            alternativesElement.appendChild(altElement);
        });
    }

    // Update material properties based on material type
    updateMaterialProperties(materialData.material_type);

    // Update care instructions based on material type
    updateCareInstructions(materialData.material_type);
}

/**
 * Update material properties bars based on material type
 */
function updateMaterialProperties(materialType) {
    // Define property values for different materials
    const materialProperties = {
        'cotton': {
            breathability: 90,
            durability: 70,
            warmth: 50
        },
        'silk': {
            breathability: 95,
            durability: 30,
            warmth: 40
        },
        'wool': {
            breathability: 60,
            durability: 75,
            warmth: 90
        },
        'polyester': {
            breathability: 40,
            durability: 90,
            warmth: 65
        },
        'denim': {
            breathability: 50,
            durability: 95,
            warmth: 60
        },
        'leather': {
            breathability: 30,
            durability: 85,
            warmth: 70
        },
        'textured': {
            breathability: 60,
            durability: 80,
            warmth: 65
        },
        'smooth': {
            breathability: 80,
            durability: 50,
            warmth: 45
        },
        'patterned': {
            breathability: 70,
            durability: 65,
            warmth: 55
        },
        'rough_textured': {
            breathability: 50,
            durability: 90,
            warmth: 80
        },
        'medium': {
            breathability: 75,
            durability: 70,
            warmth: 60
        },
        'unknown': {
            breathability: 50,
            durability: 50,
            warmth: 50
        }
    };

    // Get properties for the material type (or default to unknown)
    const properties = materialProperties[materialType.toLowerCase()] || materialProperties.unknown;

    // Update progress bars
    document.getElementById('breathability-bar').style.width = `${properties.breathability}%`;
    document.getElementById('durability-bar').style.width = `${properties.durability}%`;
    document.getElementById('warmth-bar').style.width = `${properties.warmth}%`;
}

/**
 * Update care instructions based on material type
 */
function updateCareInstructions(materialType) {
    const careElement = document.getElementById('care-instructions');
    if (!careElement) return;

    // Define care instructions for different materials
    const careInstructions = {
        'cotton': [
            { icon: 'tint', text: 'Machine wash at 40°C' },
            { icon: 'wind', text: 'Tumble dry on low heat' },
            { icon: 'tshirt', text: 'Iron on medium heat' }
        ],
        'silk': [
            { icon: 'tint', text: 'Hand wash in cold water' },
            { icon: 'wind', text: 'Do not tumble dry' },
            { icon: 'tshirt', text: 'Iron on low heat or steam' }
        ],
        'wool': [
            { icon: 'tint', text: 'Hand wash or dry clean' },
            { icon: 'wind', text: 'Lay flat to dry' },
            { icon: 'tshirt', text: 'Iron on low heat with steam' }
        ],
        'polyester': [
            { icon: 'tint', text: 'Machine wash at 30°C' },
            { icon: 'wind', text: 'Tumble dry on low heat' },
            { icon: 'tshirt', text: 'Iron on low heat if needed' }
        ],
        'denim': [
            { icon: 'tint', text: 'Machine wash cold inside out' },
            { icon: 'wind', text: 'Line dry to prevent shrinking' },
            { icon: 'tshirt', text: 'Iron on medium heat if needed' }
        ],
        'leather': [
            { icon: 'tint', text: 'Wipe with damp cloth' },
            { icon: 'wind', text: 'Air dry away from heat' },
            { icon: 'tshirt', text: 'Use leather conditioner' }
        ],
        'textured': [
            { icon: 'tint', text: 'Machine wash at 30°C' },
            { icon: 'wind', text: 'Tumble dry on low heat' },
            { icon: 'tshirt', text: 'Iron on medium heat' }
        ],
        'smooth': [
            { icon: 'tint', text: 'Gentle wash at 30°C' },
            { icon: 'wind', text: 'Line dry or lay flat' },
            { icon: 'tshirt', text: 'Iron on low heat if needed' }
        ],
        'rough_textured': [
            { icon: 'tint', text: 'Machine wash cold' },
            { icon: 'wind', text: 'Tumble dry on low heat' },
            { icon: 'tshirt', text: 'Iron on medium heat if needed' }
        ],
        'unknown': [
            { icon: 'tint', text: 'Machine wash at 30°C' },
            { icon: 'wind', text: 'Tumble dry on low heat' },
            { icon: 'tshirt', text: 'Iron on medium heat' }
        ]
    };

    // Get care instructions for the material type (or default to unknown)
    const instructions = careInstructions[materialType.toLowerCase()] || careInstructions.unknown;

    // Update care instructions
    careElement.innerHTML = '';
    instructions.forEach(instruction => {
        const careInstruction = document.createElement('div');
        careInstruction.className = 'care-instruction';
        careInstruction.innerHTML = `
            <div class="care-icon">
                <i class="fas fa-${instruction.icon}"></i>
            </div>
            <div class="care-text">${instruction.text}</div>
        `;
        careElement.appendChild(careInstruction);
    });
}

/**
 * Main initialization when DOM content is loaded
 */
document.addEventListener('DOMContentLoaded', function() {
  // Initialize fabric viewer
  const canvasContainer = document.getElementById('canvas-container');
  if (canvasContainer) {
    window.fabricViewer = new EnhancedFabricViewer(canvasContainer);
  }

  // Set up view mode toggle buttons
  document.querySelectorAll('.view-mode-button').forEach(button => {
    button.addEventListener('click', function() {
      // Update active button
      document.querySelectorAll('.view-mode-button').forEach(btn => {
        btn.classList.remove('active');
      });
      this.classList.add('active');

      // Set corresponding light mode
      const mode = this.dataset.mode;
      if (window.fabricViewer) {
        window.fabricViewer.setLightingMode(mode);
      }
    });
  });

  // Set up item select dropdown
  const itemSelect = document.getElementById('item-select');
  if (itemSelect) {
    itemSelect.addEventListener('change', function() {
      if (!this.value) return;

      // Show loading overlay
      if (window.fabricViewer) {
        window.fabricViewer.showLoading('Loading item data...');
      }

      // Fetch item data from server
      fetch(`/api/wardrobe/material/${this.value}`)
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            // Format the item data
            const itemData = {
              _id: data.itemId,
              label: data.label,
              file_path: data.texturePath,
              normal_map_path: data.normalMapPath,
              material_properties: data.materialProperties
            };

            // Update UI
            document.getElementById('fabric-info-panel').style.display = 'block';

            // Load and visualize the item
            if (window.fabricViewer) {
              window.fabricViewer.loadClothingItem(itemData)
                .catch(error => {
                  console.error('Error loading item:', error);
                  window.fabricViewer.showError('Error loading item');
                });
            }

            // Update material settings UI
            updateMaterialSettingsUI(data.materialProperties);
          } else {
            throw new Error(data.error || 'Error fetching item data');
          }
        })
        .catch(error => {
          console.error('Error:', error);
          if (window.fabricViewer) {
            window.fabricViewer.hideLoading();
            window.fabricViewer.showError('Error loading item data');
          }
        });
    });
  }

  // Set up slider controls
  setupMaterialSliders();

  // Set up Apply Selected Fabric button
  const applyFabricBtn = document.getElementById('apply-selected-fabric-btn');
  if (applyFabricBtn) {
    applyFabricBtn.addEventListener('click', function() {
      const selectedSwatch = document.querySelector('.fabric-swatch.selected');
      if (!selectedSwatch || !window.fabricViewer || !window.fabricViewer.currentModel) return;

      const fabricImgUrl = selectedSwatch.dataset.fabricImg;
      if (fabricImgUrl) {
        // Get current material properties
        const itemSelect = document.getElementById('item-select');
        const itemId = itemSelect?.value;

        if (itemId) {
          fetch(`/api/wardrobe/material/${itemId}`)
            .then(response => response.json())
            .then(data => {
              if (data.success) {
                // Apply the new fabric texture but keep the material properties
                window.fabricViewer.applyMaterial(
                  window.fabricViewer.currentModel,
                  fabricImgUrl,
                  data.materialProperties,
                  data.normalMapPath
                );
              }
            })
            .catch(error => {
              console.error('Error fetching material data:', error);
            });
        }
      }
    });
  }

  // Debug visualization button
  document.addEventListener('click', function(e) {
      if (e.target && e.target.id === 'debug-color-btn') {
          // Show debug panel
          const debugPanel = document.getElementById('color-debug-panel');
          const debugContainer = document.getElementById('debug-image-container');
          if (debugPanel) {
              debugPanel.style.display = 'block';

              // Check if we have an item ID (from current debug session)
              const latestItemId = localStorage.getItem('latestItemId');
              if (latestItemId) {
                  debugColorDetection(latestItemId);
              } else {
                  debugContainer.innerHTML = '<p>No item data available to debug.</p>';
              }
          }
      }

      if (e.target && e.target.id === 'show-debug-btn') {
          const debugContainer = document.getElementById('debug-image-container');
          if (debugContainer) {
              if (debugContainer.style.display === 'none' || !debugContainer.style.display) {
                  debugContainer.style.display = 'block';
                  e.target.textContent = 'Hide Color Analysis Details';
              } else {
                  debugContainer.style.display = 'none';
                  e.target.textContent = 'Show Color Analysis Details';
              }
          }
      }

      // Advanced Material Analysis button
      if (e.target && e.target.id === 'analyze-material-btn') {
          const fileInput = document.getElementById('imageUpload');
          if (fileInput && fileInput.files && fileInput.files[0]) {
              // Show loading state
              e.target.textContent = 'Analyzing...';
              e.target.disabled = true;

              // Run advanced material analysis
              analyzeMaterial(fileInput.files[0])
                  .then(result => {
                      console.log('Material analysis complete:', result);
                      // Reset button
                      e.target.textContent = 'Advanced Material Analysis';
                      e.target.disabled = false;
                  })
                  .catch(error => {
                      console.error('Material analysis failed:', error);
                      // Reset button
                      e.target.textContent = 'Advanced Material Analysis';
                      e.target.disabled = false;
                  });
          } else {
              alert('Please upload an image first');
          }
      }
  });

  // Connect View in 3D button from the result page
  document.addEventListener('click', function(e) {
    if (e.target && e.target.id === 'view-in-3d-btn') {
      // Switch to 3D viewer mode
      document.getElementById('view-mode-btn').click();
    }
  });

  // Set up update material button
  const updateMaterialBtn = document.getElementById('update-material-btn');
  if (updateMaterialBtn) {
    updateMaterialBtn.addEventListener('click', function() {
      if (!window.fabricViewer) return;

      // Get values from sliders
      const roughness = parseFloat(document.getElementById('roughness-slider').value);
      const metalness = parseFloat(document.getElementById('metalness-slider').value);
      const normalStrength = parseFloat(document.getElementById('normal-strength-slider').value);
      const textureScale = parseFloat(document.getElementById('pattern-scale-slider').value);
      const useNormalMap = document.getElementById('use-normal-map-checkbox').checked;
      const useColor = document.getElementById('use-color-checkbox').checked;

      // Update material properties
      window.fabricViewer.updateMaterialProperties({
        roughness,
        metalness,
        normalScale: useNormalMap ? normalStrength : 0,
        textureScale
      });
    });
  }

  // Pre-select first item if available
  if (itemSelect && itemSelect.options.length > 1) {
    itemSelect.selectedIndex = 1;
    itemSelect.dispatchEvent(new Event('change'));
  }
});

/**
 * Set up material sliders with event handlers
 */
function setupMaterialSliders() {
  const sliders = [
    { id: 'roughness-slider', valueId: 'roughness-value' },
    { id: 'metalness-slider', valueId: 'metalness-value' },
    { id: 'color-intensity-slider', valueId: 'color-intensity-value' },
    { id: 'pattern-scale-slider', valueId: 'pattern-scale-value' },
    { id: 'pattern-rotation-slider', valueId: 'pattern-rotation-value' },
    { id: 'normal-strength-slider', valueId: 'normal-strength-value' }
  ];

  sliders.forEach(({ id, valueId }) => {
    const slider = document.getElementById(id);
    const valueEl = document.getElementById(valueId);

    if (slider && valueEl) {
      slider.addEventListener('input', function() {
        let displayValue;

        if (id === 'pattern-rotation-slider') {
          displayValue = `${this.value}°`;
        } else {
          displayValue = parseFloat(this.value).toFixed(1);
        }

        valueEl.textContent = displayValue;
      });
    }
  });
}

/**
 * Update material settings UI based on material properties
 */
function updateMaterialSettingsUI(materialProperties) {
  if (!materialProperties) return;

  // Get parameters for this material
  const materialType = materialProperties.estimated_material || 'medium';
  const edgeDensity = materialProperties.edge_density || 0.1;
  const textureVariance = materialProperties.texture_variance || 100;

  // Set roughness based on material type
  const roughnessMap = {
    'smooth': 0.3,
    'textured': 0.7,
    'rough_textured': 0.9,
    'patterned': 0.6,
    'medium': 0.5
  };

  let roughness = roughnessMap[materialType] || 0.5;

  // Adjust for edge density
  if (edgeDensity > 0.3) {
    roughness = Math.min(1.0, roughness + 0.2);
  } else if (edgeDensity < 0.05) {
    roughness = Math.max(0.1, roughness - 0.2);
  }

  // Set normal strength based on texture variance and pattern
  let normalStrength = 1.0;
  if (textureVariance > 200) {
    normalStrength = 1.5;
  } else if (textureVariance < 50) {
    normalStrength = 0.5;
  }

  // Enhance for pattern strength
  if (materialProperties.pattern_info && materialProperties.pattern_info.pattern_strength > 0.5) {
    normalStrength = Math.min(3.0, normalStrength * 1.5);
  }

  // Update UI sliders
  const roughnessSlider = document.getElementById('roughness-slider');
  const roughnessValue = document.getElementById('roughness-value');
  if (roughnessSlider && roughnessValue) {
    roughnessSlider.value = roughness;
    roughnessValue.textContent = roughness.toFixed(1);
  }

  const normalStrengthSlider = document.getElementById('normal-strength-slider');
  const normalStrengthValue = document.getElementById('normal-strength-value');
  if (normalStrengthSlider && normalStrengthValue) {
    normalStrengthSlider.value = normalStrength;
    normalStrengthValue.textContent = normalStrength.toFixed(1);
  }

  // Set pattern scale based on pattern info
  let patternScale = 1.0;
  if (materialProperties.pattern_info) {
    if (materialProperties.pattern_info.pattern_scale === 'fine') {
      patternScale = 2.0;
    } else if (materialProperties.pattern_info.pattern_scale === 'large') {
      patternScale = 0.7;
    }
  }

  const patternScaleSlider = document.getElementById('pattern-scale-slider');
  const patternScaleValue = document.getElementById('pattern-scale-value');
  if (patternScaleSlider && patternScaleValue) {
    patternScaleSlider.value = patternScale;
    patternScaleValue.textContent = patternScale.toFixed(1);
  }
}

// Image upload preview
document.getElementById('imageUpload').addEventListener('change', function(e) {
    const imageSection = document.querySelector('.image-section');
    const previewDiv = document.getElementById('imagePreview');
    const file = e.target.files[0];

    if (!file) return;

    imageSection.style.display = 'block';

    const reader = new FileReader();
    reader.onload = function(e) {
        const img = document.createElement('img');
        img.src = e.target.result;
        img.style.maxWidth = '300px';
        img.style.height = 'auto';
        img.style.borderRadius = '8px';
        img.style.boxShadow = '0 2px 4px rgba(0,0,0,0.1)';

        previewDiv.innerHTML = '';
        previewDiv.appendChild(img);
    };
    reader.readAsDataURL(file);
});

// Predict button click handler - enhanced to use improved result template
document.getElementById('btn-predict').addEventListener('click', async function() {
    const fileInput = document.getElementById('imageUpload');
    const resultDiv = document.getElementById('result');
    const loader = document.querySelector('.loader');

    if (!fileInput.files[0]) {
        alert('Please select an image first');
        return;
    }

    loader.style.display = 'block';
    resultDiv.innerHTML = '';

    const formData = new FormData();
    formData.append('file', fileInput.files[0]);

    try {
        const response = await fetch('/wardrobe', {
            method: 'POST',
            body: formData
        });

        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();
        if (data.error) {
            throw new Error(data.error);
        }

        // Store the item ID for debug purposes
        if (data._id) {
            localStorage.setItem('latestItemId', data._id);
        }

        // Get the improved template
        const template = document.getElementById('improved-result-template');
        const content = template.content.cloneNode(true);

        // Update template with prediction data
        content.querySelector('#result-type').textContent = data.prediction || 'Unknown';

        // Infer fabric type based on material properties or prediction
        let fabricType = "Unknown";
        if (data.material_properties?.estimated_material) {
            const materialMap = {
                'smooth': 'Silk',
                'textured': 'Denim',
                'rough_textured': 'Tweed',
                'patterned': 'Printed Fabric',
                'medium': 'Cotton'
            };
            fabricType = materialMap[data.material_properties.estimated_material] || 'Fabric';
        } else if (data.prediction) {
            // Fallback to typical fabrics based on clothing type
            const clothingFabricMap = {
                'T-shirt/top': 'Cotton',
                'Trouser': 'Denim',
                'Pullover': 'Wool',
                'Dress': 'Polyester',
                'Coat': 'Wool Blend',
                'Sandal': 'Leather',
                'Shirt': 'Cotton',
                'Sneaker': 'Canvas',
                'Bag': 'Leather',
                'Ankle boot': 'Leather'
            };
            fabricType = clothingFabricMap[data.prediction] || 'Fabric';
        }
        content.querySelector('#result-fabric').textContent = fabricType;

        // Update color information
        if (data.color && data.color.rgb) {
            const rgbColor = `rgb(${data.color.rgb.join(', ')})`;
            const percentage = (data.color.percentage * 100).toFixed(1);

            content.querySelector('#color-preview').style.backgroundColor = rgbColor;
            content.querySelector('#result-color').textContent = `RGB: ${data.color.rgb.join(', ')}`;
            content.querySelector('#result-percentage').textContent = `Percentage: ${percentage}%`;
        }

        // Update material analysis
        if (data.material_properties) {
            const mp = data.material_properties;
            content.querySelector('#material-type').textContent = mp.estimated_material || 'unknown';
            content.querySelector('#texture-variance').textContent = mp.texture_variance ? mp.texture_variance.toFixed(2) : '0.00';
            content.querySelector('#edge-density').textContent = mp.edge_density ? mp.edge_density.toFixed(4) : '0.0000';

            // Update pattern information
            if (mp.pattern_info) {
                const patternInfo = mp.pattern_info;
                content.querySelector('#pattern-type').textContent = patternInfo.pattern_type || 'regular';
                const patternStrength = patternInfo.pattern_strength || 0;
                content.querySelector('#pattern-strength').textContent = `${(patternStrength * 100).toFixed(0)}%`;
            }
        }

        // Set texture preview if available
        let texturePath = data.texture_preview_path || data.file_path;
        if (texturePath) {
            content.querySelector('#texture-preview').src = texturePath;
        }

        // Append to result div
        resultDiv.appendChild(content);

        // Add event listener for the View in 3D button
        document.getElementById('view-in-3d-btn').addEventListener('click', function() {
            // Switch to 3D Clothes Viewer mode
            document.getElementById('view-mode-btn').click();

            // If we have a newly created item, select it
            setTimeout(() => {
                // Use the latest item data for 3D viewing
                if (window.fabricViewer) {
                    window.fabricViewer.loadClothingItem({
                        label: data.prediction,
                        file_path: texturePath,
                        material_properties: data.material_properties,
                        normal_map_path: data.normal_map_path
                    });
                }

                // Show fabric info panel
                document.getElementById('fabric-info-panel').style.display = 'block';
            }, 500);
        });

        // Add event listener for the Debug Color button
        if (document.getElementById('debug-color-btn')) {
            document.getElementById('debug-color-btn').addEventListener('click', function() {
                // Get the latest item ID
                const latestItemId = localStorage.getItem('latestItemId');
                if (latestItemId) {
                    debugColorDetection(latestItemId);
                }
            });
        }

    } catch (error) {
        console.error('Error:', error);
        resultDiv.innerHTML = `
            <div class="error-message p-4 bg-red-100 text-red-700 rounded-lg">
                ${error.message || 'Error processing image. Please try again.'}
            </div>
        `;
    } finally {
        loader.style.display = 'none';
    }
});

// Mode toggle functionality
document.getElementById('upload-mode-btn').addEventListener('click', function() {
    this.classList.add('btn-primary');
    this.classList.remove('btn-secondary');
    document.getElementById('view-mode-btn').classList.add('btn-secondary');
    document.getElementById('view-mode-btn').classList.remove('btn-primary');

    document.querySelector('.upload-container').classList.add('active');
    document.querySelector('.viewer-container').classList.remove('active');
});

document.getElementById('view-mode-btn').addEventListener('click', function() {
    this.classList.add('btn-primary');
    this.classList.remove('btn-secondary');
    document.getElementById('upload-mode-btn').classList.add('btn-secondary');
    document.getElementById('upload-mode-btn').classList.remove('btn-primary');

    document.querySelector('.viewer-container').classList.add('active');
    document.querySelector('.upload-container').classList.remove('active');
});

// Tab navigation
document.querySelectorAll('.tab-button').forEach(button => {
    button.addEventListener('click', function() {
        // Remove active class from all buttons and panels
        document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
        document.querySelectorAll('.tab-panel').forEach(panel => panel.classList.remove('active'));

        // Add active class to clicked button
        this.classList.add('active');

        // Show corresponding panel
        const tabId = this.getAttribute('data-tab');
        document.getElementById(tabId).classList.add('active');
    });
});
</script>
{% endblock %}
