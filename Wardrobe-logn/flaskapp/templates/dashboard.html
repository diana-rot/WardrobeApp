{% extends "base.html" %}

{% block title %}Dashboard - WardrobeApp{% endblock %}

{% block extra_css %}
<style>
    /* Dashboard Grid Layout */
    .dashboard-container {
        padding: 20px;
        max-width: 1600px;
        margin: 0 auto;
    }

    .dashboard-grid {
        display: grid;
        grid-template-columns: 400px 600px 350px;
        gap: 25px;
        margin-top: 20px;
    }

    /* Responsive grid for smaller screens */
    @media (max-width: 1400px) {
        .dashboard-grid {
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
        }
    }

    /* Enhanced Card Styles */
    .dashboard-card {
        background: linear-gradient(135deg, rgba(255,255,255,0.95), rgba(255,255,255,0.85));
        border: none;
        border-radius: 20px;
        box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        backdrop-filter: blur(10px);
        transition: all 0.3s ease;
        overflow: hidden;
        position: relative;
    }

    .dashboard-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 12px 40px rgba(0,0,0,0.15);
    }

    .dashboard-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(90deg, #C8A68D, #9C7D68, #876955);
    }

    /* Weather Card */
    .weather-card {
        margin-bottom: 15px;
        padding: 15px;
        border-radius: 12px;
        background: linear-gradient(135deg, rgba(200,166,141,0.2), rgba(156,125,104,0.1));
        border: 1px solid rgba(200,166,141,0.3);
        transition: all 0.3s ease;
    }

    .weather-card:hover {
        background: linear-gradient(135deg, rgba(200,166,141,0.3), rgba(156,125,104,0.2));
        transform: scale(1.02);
    }

    .weather-icon {
        width: 50px;
        height: 50px;
    }

    /* Avatar Preview Styles */
    .avatar-preview-container {
        height: 300px;
        background: linear-gradient(135deg, #f8f9fa, #e9ecef);
        border-radius: 15px;
        position: relative;
        overflow: hidden;
        margin-bottom: 20px;
    }

    .avatar-3d-viewport {
        width: 100%;
        height: 100%;
        border-radius: 15px;
    }

    .avatar-placeholder {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100%;
        color: #6c757d;
        text-align: center;
    }

    .avatar-placeholder i {
        font-size: 48px;
        margin-bottom: 15px;
        opacity: 0.6;
    }

    .outfit-info-overlay {
        position: absolute;
        bottom: 10px;
        left: 10px;
        right: 10px;
        background: rgba(255,255,255,0.9);
        backdrop-filter: blur(10px);
        border-radius: 8px;
        padding: 10px;
        transform: translateY(100%);
        transition: transform 0.3s ease;
    }

    .avatar-preview-container:hover .outfit-info-overlay {
        transform: translateY(0);
    }

    /* Calendar Preview Styles */
    .calendar-preview {
        background: #f8f9fa;
        border-radius: 15px;
        padding: 20px;
        margin-bottom: 20px;
    }

    .calendar-mini-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 10px;
        margin-top: 15px;
    }

    .calendar-day {
        aspect-ratio: 1;
        border-radius: 8px;
        background: white;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: flex-start;
        font-size: 13px;
        position: relative;
        transition: all 0.2s ease;
        border: 1px solid #dee2e6;
        padding: 6px;
        min-height: 75px;
    }

    .calendar-day.has-outfit {
        background: linear-gradient(135deg, #C8A68D, #9C7D68);
        color: white;
        font-weight: 600;
    }

    .calendar-day.today {
        border: 2px solid #C8A68D;
        font-weight: bold;
    }

    .calendar-day:hover {
        transform: scale(1.05);
        z-index: 2;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    .calendar-day-number {
        font-weight: bold;
        margin-bottom: 2px;
    }

    .calendar-outfit-preview {
        display: flex;
        flex-wrap: wrap;
        gap: 2px;
        justify-content: center;
        width: 100%;
        margin-top: 4px;
    }

    .calendar-outfit-item {
        width: 18px;
        height: 18px;
        border-radius: 3px;
        background-size: cover;
        background-position: center;
        border: 1px solid rgba(255,255,255,0.7);
        transition: transform 0.2s ease;
    }

    .calendar-outfit-item:hover {
        transform: scale(1.2);
        z-index: 3;
        border: 2px solid white;
        box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    }

    .upcoming-outfits {
        margin-top: 15px;
    }

    .outfit-item-mini {
        display: flex;
        align-items: center;
        padding: 8px;
        background: white;
        border-radius: 8px;
        margin-bottom: 8px;
        border: 1px solid #dee2e6;
        transition: all 0.2s ease;
    }

    .outfit-item-mini:hover {
        background: #f8f9fa;
        transform: translateX(5px);
    }

    .outfit-date-mini {
        background: #C8A68D;
        color: white;
        border-radius: 6px;
        padding: 4px 8px;
        font-size: 11px;
        font-weight: 600;
        margin-right: 10px;
        min-width: 40px;
        text-align: center;
    }

    .outfit-preview-mini {
        display: flex;
        gap: 4px;
        margin-right: 10px;
    }

    .outfit-preview-mini img {
        width: 25px;
        height: 25px;
        border-radius: 4px;
        object-fit: cover;
        border: 1px solid #dee2e6;
    }

    /* Quick Stats */
    .quick-stats {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 15px;
        margin-bottom: 20px;
    }

    .stat-item {
        text-align: center;
        padding: 15px;
        background: linear-gradient(135deg, rgba(200,166,141,0.1), rgba(156,125,104,0.05));
        border-radius: 12px;
        border: 1px solid rgba(200,166,141,0.2);
    }

    .stat-number {
        font-size: 24px;
        font-weight: 700;
        color: #9C7D68;
        display: block;
    }

    .stat-label {
        font-size: 12px;
        color: #6c757d;
        margin-top: 5px;
    }

    /* Action Buttons */
    .action-buttons {
        display: flex;
        gap: 10px;
        margin-top: 15px;
    }

    .btn-dashboard {
        flex: 1;
        padding: 12px;
        border-radius: 10px;
        border: none;
        font-weight: 600;
        text-decoration: none;
        text-align: center;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
    }

    .btn-dashboard.primary {
        background: linear-gradient(135deg, #C8A68D, #9C7D68);
        color: white;
    }

    .btn-dashboard.primary:hover {
        background: linear-gradient(135deg, #9C7D68, #876955);
        transform: translateY(-2px);
        color: white;
    }

    .btn-dashboard.secondary {
        background: #f8f9fa;
        color: #6c757d;
        border: 1px solid #dee2e6;
    }

    .btn-dashboard.secondary:hover {
        background: #e9ecef;
        color: #495057;
        transform: translateY(-2px);
    }

    /* Card Headers */
    .card-header-custom {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 2px solid #f8f9fa;
    }

    .card-title-custom {
        font-size: 18px;
        font-weight: 700;
        color: #2c3e50;
        margin: 0;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .card-title-custom i {
        color: #C8A68D;
    }

    /* Loading States */
    .loading-placeholder {
        background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
        background-size: 200% 100%;
        animation: loading 1.5s infinite;
        border-radius: 8px;
        height: 20px;
        margin-bottom: 10px;
    }

    @keyframes loading {
        0% { background-position: 200% 0; }
        100% { background-position: -200% 0; }
    }

    /* Responsive Design */
    @media (max-width: 1400px) {
        .dashboard-grid {
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
        }
    }

    @media (max-width: 768px) {
        .dashboard-grid {
            grid-template-columns: 1fr;
            gap: 20px;
        }

        .quick-stats {
            grid-template-columns: repeat(2, 1fr);
        }

        .action-buttons {
            flex-direction: column;
        }

        .calendar-mini-grid {
            gap: 6px;
        }

        .calendar-day {
            font-size: 11px;
            min-height: 50px;
        }

        .calendar-outfit-item {
            width: 16px;
            height: 16px;
        }
    }

    /* Toast Styles */
    .toast-container {
        z-index: 1050;
    }

    .toast {
        background: rgba(255,255,255,0.95);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(200,166,141,0.3);
    }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <!-- Page Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h2 mb-1">Dashboard</h1>
            <p class="text-muted mb-0">Welcome back! Here's your wardrobe overview.</p>
        </div>
        <div class="d-flex gap-2">
            <a href="/avatar" class="btn btn-outline-primary btn-sm">
                <i class="bi bi-person-gear"></i> Avatar
            </a>
            <a href="/calendar" class="btn btn-outline-primary btn-sm">
                <i class="bi bi-calendar3"></i> Calendar
            </a>
        </div>
    </div>

    <!-- Dashboard Grid -->
    <div class="dashboard-grid">

        <!-- Avatar Preview Card -->
        <div class="dashboard-card">
            <div class="card-body p-4">
                <div class="card-header-custom">
                    <h5 class="card-title-custom">
                        <i class="bi bi-person-gear"></i>
                        Your Avatar
                    </h5>
                    <span class="badge bg-light text-dark" id="avatar-status">Loading...</span>
                </div>

                <!-- Avatar 3D Preview -->
                <div class="avatar-preview-container" id="avatar-preview-container">
                    <div class="avatar-placeholder" id="avatar-placeholder">
                        <i class="bi bi-person-circle"></i>
                        <h6>Loading Avatar...</h6>
                        <small class="text-muted">Please wait while we load your avatar</small>
                    </div>

                    <!-- Outfit Info Overlay -->
                    <div class="outfit-info-overlay" id="outfit-info-overlay" style="display: none;">
                        <h6 class="mb-1" id="outfit-name">Current Outfit</h6>
                        <small class="text-muted" id="outfit-details">No outfit selected</small>
                    </div>
                </div>

                <!-- Avatar Stats -->
                <div class="quick-stats">
                    <div class="stat-item">
                        <span class="stat-number" id="avatar-outfits-count">-</span>
                        <div class="stat-label">Saved Outfits</div>
                    </div>
                    <div class="stat-item">
                        <span class="stat-number" id="avatar-items-count">-</span>
                        <div class="stat-label">Wardrobe Items</div>
                    </div>
                    <div class="stat-item">
                        <span class="stat-number" id="avatar-created-date">-</span>
                        <div class="stat-label">Days Active</div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="action-buttons">
                    <a href="/avatar" class="btn-dashboard primary">
                        <i class="bi bi-palette"></i>
                        Customize Avatar
                    </a>
                    <button class="btn-dashboard secondary" onclick="refreshAvatar()">
                        <i class="bi bi-arrow-clockwise"></i>
                        Refresh
                    </button>
                </div>
            </div>
        </div>

        <!-- Calendar Preview Card -->
        <div class="dashboard-card">
            <div class="card-body p-4">
                <div class="card-header-custom">
                    <h5 class="card-title-custom">
                        <i class="bi bi-calendar3"></i>
                        Outfit Calendar
                    </h5>
                    <span class="badge bg-light text-dark" id="calendar-month">Loading...</span>
                </div>

                <!-- Mini Calendar -->
                <div class="calendar-preview">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <button class="btn btn-sm btn-outline-secondary" onclick="navigateCalendar(-1)" title="Previous month">
                            <i class="bi bi-chevron-left"></i>
                        </button>
                        <h6 class="mb-0" id="mini-calendar-title">June 2025</h6>
                        <button class="btn btn-sm btn-outline-secondary" onclick="navigateCalendar(1)" title="Next month">
                            <i class="bi bi-chevron-right"></i>
                        </button>
                    </div>

                    <div class="calendar-mini-grid" id="mini-calendar-grid">
                        <!-- Calendar days will be populated by JavaScript -->
                    </div>
                </div>

                <!-- Upcoming Outfits -->
                <div class="upcoming-outfits">
                    <h6 class="mb-3">
                        <i class="bi bi-clock"></i>
                        Upcoming Outfits
                    </h6>
                    <div id="upcoming-outfits-list">
                        <div class="loading-placeholder"></div>
                        <div class="loading-placeholder"></div>
                        <div class="loading-placeholder"></div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="action-buttons">
                    <a href="/calendar" class="btn-dashboard primary">
                        <i class="bi bi-calendar-plus"></i>
                        Plan Outfits
                    </a>
                    <button class="btn-dashboard secondary" onclick="refreshCalendar()">
                        <i class="bi bi-arrow-clockwise"></i>
                        Refresh
                    </button>
                </div>
            </div>
        </div>

        <!-- Weather Card (Enhanced) -->
        <div class="dashboard-card">
            <div class="card-body p-4">
                <div class="card-header-custom">
                    <h5 class="card-title-custom">
                        <i class="bi bi-cloud-sun"></i>
                        Weather
                    </h5>
                    <button class="btn btn-sm btn-outline-secondary" onclick="refreshWeather()">
                        <i class="bi bi-arrow-clockwise"></i>
                    </button>
                </div>

                <!-- Add City Form -->
                <form id="weatherForm" method="POST" class="mb-3">
                    <div class="input-group">
                        <input type="text"
                               class="form-control"
                               name="city"
                               id="cityInput"
                               placeholder="Add a city..."
                               required>
                        <button class="btn btn-outline-primary" type="submit">
                            <i class="bi bi-plus"></i>
                        </button>
                    </div>
                </form>

                <!-- Weather Data -->
                <div id="weatherData">
                    {% for weather in weather_data %}
                    <div class="weather-card" data-city="{{ weather.city }}">
                        <div class="d-flex align-items-center justify-content-between">
                            <div class="d-flex align-items-center">
                                <img src="https://openweathermap.org/img/wn/{{ weather.icon }}@2x.png"
                                     alt="Weather icon"
                                     class="weather-icon me-3">
                                <div>
                                    <h6 class="mb-1">{{ weather.city }}</h6>
                                    <div class="fw-bold text-primary">{{ weather.temperature }}Â°C</div>
                                    <small class="text-muted">{{ weather.description|title }}</small>
                                </div>
                            </div>
                            <button class="btn btn-link text-danger delete-city"
                                    data-city="{{ weather.city }}"
                                    title="Remove city">
                                <i class="bi bi-x-lg"></i>
                            </button>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Quick Actions Card -->
        <div class="dashboard-card">
            <div class="card-body p-4">
                <div class="card-header-custom">
                    <h5 class="card-title-custom">
                        <i class="bi bi-lightning"></i>
                        Quick Actions
                    </h5>
                </div>

                <!-- Wardrobe Stats -->
                <div class="quick-stats mb-3">
                    <div class="stat-item">
                        <span class="stat-number" id="wardrobe-total-items">-</span>
                        <div class="stat-label">Total Items</div>
                    </div>
                    <div class="stat-item">
                        <span class="stat-number" id="wardrobe-outfits">-</span>
                        <div class="stat-label">Outfits</div>
                    </div>
                    <div class="stat-item">
                        <span class="stat-number" id="wardrobe-favorites">-</span>
                        <div class="stat-label">Favorites</div>
                    </div>
                </div>

                <!-- Quick Navigation -->
                <div class="d-grid gap-2">
                    <a href="/wardrobe" class="btn-dashboard primary">
                        <i class="bi bi-plus-circle"></i>
                        Add to Wardrobe
                    </a>
                    <a href="/recommendations" class="btn-dashboard secondary">
                        <i class="bi bi-stars"></i>
                        Get Outfit Suggestions
                    </a>
                    <a href="/wardrobe/all" class="btn-dashboard secondary">
                        <i class="bi bi-grid"></i>
                        View All Items
                    </a>
                </div>
            </div>
        </div>

    </div>
</div>

<!-- Toast Container -->
<div class="toast-container position-fixed top-0 end-0 p-3">
    <div id="dashboardToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header">
            <i class="bi bi-info-circle me-2"></i>
            <strong class="me-auto">Dashboard</strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
        </div>
        <div class="toast-body" id="toastMessage"></div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Three.js for Avatar Preview -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/OBJLoader.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize dashboard
    console.log('ðŸŽ¯ Initializing Enhanced Dashboard...');

    // Initialize current date variables BEFORE any functions use them
    const today = new Date();
    let currentCalendarYear = today.getFullYear();
    let currentCalendarMonth = today.getMonth() + 1;

    // Initialize all systems
    initializeWeatherSystem();
    initializeAvatarPreview();
    initializeCalendarPreview();
    loadDashboardStats();

    console.log('âœ… Dashboard initialization complete!');

    // Weather System
    function initializeWeatherSystem() {
        const weatherForm = document.getElementById('weatherForm');
        const weatherData = document.getElementById('weatherData');

        if (!weatherForm || !weatherData) return;

        // Handle delete city
        weatherData.addEventListener('click', function(e) {
            const deleteBtn = e.target.closest('.delete-city');
            if (!deleteBtn) return;

            const cityName = deleteBtn.dataset.city;
            const weatherCard = deleteBtn.closest('.weather-card');

            if (confirm(`Remove ${cityName} from your weather list?`)) {
                fetch(`/dashboard/delete_city/${encodeURIComponent(cityName)}`, {
                    method: 'DELETE',
                    headers: { 'X-Requested-With': 'XMLHttpRequest' }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        weatherCard.remove();
                        showToast(data.message, 'success');
                    } else {
                        throw new Error(data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showToast('Error removing city', 'error');
                });
            }
        });

        // Handle form submission
        weatherForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const cityInput = document.getElementById('cityInput');
            const formData = new FormData(weatherForm);

            fetch('/dashboard/', {
                method: 'POST',
                headers: { 'X-Requested-With': 'XMLHttpRequest' },
                body: formData
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => Promise.reject(err));
                }
                return response.json();
            })
            .then(data => {
                data.weather_data.forEach(weather => {
                    const weatherCard = createWeatherCard(weather);
                    weatherData.insertAdjacentHTML('beforeend', weatherCard);
                });
                cityInput.value = '';
                showToast('City added successfully!', 'success');
            })
            .catch(error => {
                console.error('Error:', error);
                showToast(error.message || 'Error adding city', 'error');
            });
        });
    }

    // Avatar Preview System - FIXED TO USE YOUR REAL API
    function initializeAvatarPreview() {
        console.log('ðŸ¤– Initializing Avatar Preview...');
        loadAvatarPreview();
        loadAvatarStats();
    }

    async function loadAvatarPreview() {
        const container = document.getElementById('avatar-preview-container');
        const placeholder = document.getElementById('avatar-placeholder');
        const statusBadge = document.getElementById('avatar-status');

        if (!container || !statusBadge) return;

        try {
            statusBadge.textContent = 'Loading...';
            statusBadge.className = 'badge bg-warning text-dark';

            console.log('ðŸ“¡ Fetching saved avatar from your API...');

            // FIXED: Use your actual API endpoint
            const response = await fetch('/api/avatar/get-saved');

            if (response.ok) {
                const data = await response.json();
                console.log('ðŸ“Š API Response:', data);

                if (data.success && data.avatar) {
                    console.log('âœ… Found saved avatar configuration:', data.avatar.configuration);
                    await initMiniAvatarViewer(container, data.avatar);
                    statusBadge.textContent = 'Loaded';
                    statusBadge.className = 'badge bg-success text-white';
                } else {
                    console.log('ðŸ“Š No saved avatar found, creating default');
                    await initDefaultAvatarViewer(container);
                    statusBadge.textContent = 'Default';
                    statusBadge.className = 'badge bg-info text-white';
                }
            } else {
                console.log('ðŸ“Š API error, creating default avatar');
                await initDefaultAvatarViewer(container);
                statusBadge.textContent = 'Default';
                statusBadge.className = 'badge bg-info text-white';
            }
        } catch (error) {
            console.error('âŒ Error loading avatar preview:', error);
            showAvatarPlaceholder('Error loading avatar');
            statusBadge.textContent = 'Error';
            statusBadge.className = 'badge bg-danger text-white';
        }
    }

    async function initDefaultAvatarViewer(container) {
        const defaultConfig = {
            gender: 'female',
            bodySize: 'm',
            height: 'medium',
            skinColor: 'light',
            hairType: 'elvis_hazel',
            hairColor: 'brown',
            eyeColor: 'brown'
        };

        const defaultAvatarData = {
            configuration: defaultConfig
        };

        await initMiniAvatarViewer(container, defaultAvatarData);
    }

    async function initMiniAvatarViewer(container, avatarData) {
        try {
            container.innerHTML = '';

            if (typeof THREE === 'undefined') {
                console.error('âŒ Three.js not loaded');
                showAvatarPlaceholder('3D engine not loaded');
                return;
            }

            // Create 3D scene
            const scene = new THREE.Scene();
            const camera = new THREE.PerspectiveCamera(75, container.offsetWidth / container.offsetHeight, 0.1, 1000);
            const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });

            renderer.setSize(container.offsetWidth, container.offsetHeight);
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            container.appendChild(renderer.domElement);

            // Lighting
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
            scene.add(ambientLight);

            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(1, 1, 1);
            directionalLight.castShadow = true;
            scene.add(directionalLight);

            // FIXED: Use your actual avatar model paths
            const config = avatarData.configuration;
            const gender = config.gender || 'female';
            const bodySize = config.bodySize || 'm';
            const height = config.height || 'medium';

            // Use your MakeHuman model path structure
            const modelPath = `/static/models/makehuman/bodies/${gender}/${bodySize}_${height}.glb`;
            console.log('ðŸ“ Loading avatar model from:', modelPath);

            // Check if GLTFLoader is available
            if (typeof THREE.GLTFLoader === 'undefined') {
                console.error('âŒ GLTFLoader not available');
                showAvatarPlaceholder('3D model loader not available');
                return;
            }

            const loader = new THREE.GLTFLoader();
            loader.load(modelPath, async (gltf) => {
                const avatar = gltf.scene;
                avatar.scale.setScalar(1);
                avatar.position.y = -1;
                scene.add(avatar);

                // Store avatar reference
                window.dashboardAvatar = {
                    scene: scene,
                    avatar: avatar,
                    renderer: renderer,
                    camera: camera
                };

                // Position camera for portrait view
                camera.position.set(0, 1.6, 2.5);
                camera.lookAt(0, 1.6, 0);

                // FIXED: Load your actual favorite outfit
                await loadFavoriteOutfitOnAvatar();

                // Show outfit info overlay
                showOutfitInfo();

                // Render scene
                renderer.render(scene, camera);

                console.log('âœ… Avatar viewer initialized with saved configuration');
            }, undefined, (error) => {
                console.error('âŒ Error loading avatar model:', error);
                showAvatarPlaceholder('Failed to load avatar model');
            });

            // Handle container resize
            window.addEventListener('resize', () => {
                const width = container.offsetWidth;
                const height = container.offsetHeight;
                camera.aspect = width / height;
                camera.updateProjectionMatrix();
                renderer.setSize(width, height);
                renderer.render(scene, camera);
            });

        } catch (error) {
            console.error('âŒ Error initializing avatar viewer:', error);
            showAvatarPlaceholder('3D preview unavailable');
        }
    }

    // FIXED: Load your actual favorite outfit from your API
    async function loadFavoriteOutfitOnAvatar() {
        try {
            console.log('ðŸŽ½ Loading favorite outfit from your API...');

            // FIXED: Use your actual saved outfits API
            const response = await fetch('/api/outfits/saved');
            if (!response.ok) {
                console.log('No saved outfits found');
                return;
            }

            const data = await response.json();
            if (!data.success || !data.outfits || data.outfits.length === 0) {
                console.log('No outfit data available');
                return;
            }

            // Get the most recent outfit (your favorite)
            const favoriteOutfit = data.outfits[0];
            console.log(`Loading outfit: ${favoriteOutfit.name} with ${favoriteOutfit.items?.length || 0} items`);

            if (!favoriteOutfit.items || favoriteOutfit.items.length === 0) {
                console.log('No items in favorite outfit');
                return;
            }

            // FIXED: Load each clothing item using your actual wardrobe API
            for (const itemId of favoriteOutfit.items.slice(0, 5)) {
                try {
                    await loadClothingItemOnDashboardAvatar(itemId);
                } catch (error) {
                    console.warn(`Failed to load item ${itemId}:`, error);
                }
            }

            console.log('âœ… Favorite outfit loaded on dashboard avatar');

        } catch (error) {
            console.error('âŒ Error loading favorite outfit:', error);
        }
    }

    // FIXED: Load clothing items using your actual wardrobe API
    async function loadClothingItemOnDashboardAvatar(itemId) {
        return new Promise(async (resolve, reject) => {
            try {
                // FIXED: Use your actual wardrobe item API
                const itemResponse = await fetch(`/api/wardrobe/item/${itemId}`);
                if (!itemResponse.ok) {
                    throw new Error('Item not found');
                }

                const itemData = await itemResponse.json();
                if (!itemData.success) {
                    throw new Error('Failed to get item data');
                }

                console.log('ðŸ‘— Loading clothing item:', itemData.label);

                // FIXED: Check if item has your 3D model
                if (itemData.has_3d_model && itemData.model_3d_path) {
                    await loadOBJClothingOnDashboard(itemData);
                } else {
                    // Create simple representation
                    await createSimpleClothingMesh(itemData);
                }

                resolve();

            } catch (error) {
                console.warn(`Could not load item ${itemId}:`, error);
                resolve(); // Don't fail the whole process
            }
        });
    }

    // FIXED: Load OBJ clothing using your actual model paths
    async function loadOBJClothingOnDashboard(itemData) {
        return new Promise((resolve, reject) => {
            if (!window.dashboardAvatar || typeof THREE.OBJLoader === 'undefined') {
                console.warn('Dashboard avatar or OBJ loader not available');
                resolve();
                return;
            }

            const loader = new THREE.OBJLoader();
            const objPath = itemData.model_3d_path; // Your actual OBJ path

            console.log(`ðŸ‘— Loading 3D clothing: ${itemData.label} from ${objPath}`);

            loader.load(objPath, (object) => {
                try {
                    object.scale.setScalar(1.0);

                    // Position clothing based on type
                    const label = itemData.label?.toLowerCase() || '';

                    if (label.includes('dress')) {
                        object.position.set(0, -0.8, 0);
                        object.scale.setScalar(0.95);
                    } else if (label.includes('shirt') || label.includes('top')) {
                        object.position.set(0, 0.2, 0);
                    } else if (label.includes('trouser') || label.includes('pants')) {
                        object.position.set(0, -0.5, 0);
                    } else {
                        object.position.set(0, 0, 0);
                    }

                    // FIXED: Apply color from your item data
                    let clothingColor = 0x8B7355; // Default

                    if (itemData.color) {
                        try {
                            if (typeof itemData.color === 'string') {
                                if (itemData.color.startsWith('#')) {
                                    clothingColor = parseInt(itemData.color.substring(1), 16);
                                } else if (itemData.color.includes(' ')) {
                                    // Your RGB format: "123 45 67"
                                    const rgb = itemData.color.split(' ').map(v => parseInt(v));
                                    if (rgb.length === 3) {
                                        clothingColor = (rgb[0] << 16) | (rgb[1] << 8) | rgb[2];
                                    }
                                }
                            } else if (itemData.color.rgb && Array.isArray(itemData.color.rgb)) {
                                const rgb = itemData.color.rgb;
                                clothingColor = (rgb[0] << 16) | (rgb[1] << 8) | rgb[2];
                            }
                        } catch (e) {
                            console.warn('Could not parse color, using default');
                        }
                    }

                    // Apply material
                    object.traverse((child) => {
                        if (child.isMesh) {
                            child.material = new THREE.MeshLambertMaterial({
                                color: clothingColor,
                                side: THREE.DoubleSide
                            });
                            child.castShadow = true;
                            child.receiveShadow = true;
                        }
                    });

                    window.dashboardAvatar.avatar.add(object);

                    // Re-render
                    window.dashboardAvatar.renderer.render(
                        window.dashboardAvatar.scene,
                        window.dashboardAvatar.camera
                    );

                    console.log(`âœ… Successfully loaded 3D clothing: ${itemData.label}`);
                    resolve();

                } catch (error) {
                    console.error(`Error processing 3D clothing ${itemData.label}:`, error);
                    resolve(); // Don't fail
                }
            }, undefined, (error) => {
                console.error(`Failed to load 3D clothing ${itemData.label}:`, error);
                resolve(); // Don't fail
            });
        });
    }

    async function createSimpleClothingMesh(itemData) {
        return new Promise((resolve) => {
            try {
                if (!window.dashboardAvatar) {
                    resolve();
                    return;
                }

                console.log(`ðŸ“¦ Creating simple mesh for: ${itemData.label}`);

                let geometry;
                const label = itemData.label?.toLowerCase() || '';

                if (label.includes('dress')) {
                    geometry = new THREE.ConeGeometry(0.8, 1.8, 12);
                } else if (label.includes('shirt') || label.includes('top')) {
                    geometry = new THREE.CylinderGeometry(0.5, 0.6, 1.0, 8);
                } else if (label.includes('trouser') || label.includes('pants')) {
                    geometry = new THREE.CylinderGeometry(0.3, 0.4, 1.2, 8);
                } else {
                    geometry = new THREE.BoxGeometry(0.6, 0.8, 0.4);
                }

                // FIXED: Use your actual color data
                let clothingColor = 0x9C7D68;

                if (itemData.color) {
                    try {
                        if (typeof itemData.color === 'string' && itemData.color.includes(' ')) {
                            const rgb = itemData.color.split(' ').map(v => parseInt(v));
                            if (rgb.length === 3) {
                                clothingColor = (rgb[0] << 16) | (rgb[1] << 8) | rgb[2];
                            }
                        } else if (itemData.color.rgb && Array.isArray(itemData.color.rgb)) {
                            const rgb = itemData.color.rgb;
                            clothingColor = (rgb[0] << 16) | (rgb[1] << 8) | rgb[2];
                        }
                    } catch (e) {
                        console.warn('Could not parse color for simple mesh');
                    }
                }

                const material = new THREE.MeshLambertMaterial({
                    color: clothingColor,
                    transparent: true,
                    opacity: 0.8
                });

                const mesh = new THREE.Mesh(geometry, material);

                if (label.includes('dress')) {
                    mesh.position.set(0, -0.5, 0);
                } else if (label.includes('shirt') || label.includes('top')) {
                    mesh.position.set(0, 0.3, 0);
                } else if (label.includes('trouser') || label.includes('pants')) {
                    mesh.position.set(0, -0.3, 0);
                } else {
                    mesh.position.set(0, 0, 0);
                }

                window.dashboardAvatar.avatar.add(mesh);

                window.dashboardAvatar.renderer.render(
                    window.dashboardAvatar.scene,
                    window.dashboardAvatar.camera
                );

                console.log(`âœ… Created simple mesh for: ${itemData.label}`);
                resolve();

            } catch (error) {
                console.warn('Error creating simple clothing mesh:', error);
                resolve();
            }
        });
    }

    function showAvatarPlaceholder(message) {
        const container = document.getElementById('avatar-preview-container');
        const statusBadge = document.getElementById('avatar-status');

        if (container) {
            container.innerHTML = `
                <div class="avatar-placeholder">
                    <i class="bi bi-person-plus"></i>
                    <h6>${message}</h6>
                    <small class="text-muted">Click "Customize Avatar" to get started</small>
                </div>
            `;
        }

        if (statusBadge) {
            statusBadge.textContent = 'Not Created';
            statusBadge.className = 'badge bg-secondary text-white';
        }
    }

    // FIXED: Show outfit info using your actual outfit data
    function showOutfitInfo() {
        fetch('/api/outfits/saved')
            .then(response => response.json())
            .then(data => {
                if (data.success && data.outfits && data.outfits.length > 0) {
                    const favoriteOutfit = data.outfits[0]; // Most recent
                    const overlay = document.getElementById('outfit-info-overlay');
                    const outfitName = document.getElementById('outfit-name');
                    const outfitDetails = document.getElementById('outfit-details');

                    if (overlay && outfitName && outfitDetails) {
                        outfitName.textContent = favoriteOutfit.name;
                        outfitDetails.textContent = `${favoriteOutfit.itemCount || favoriteOutfit.items?.length || 0} items â€¢ ${favoriteOutfit.outfitType || '3D'} outfit`;
                        overlay.style.display = 'block';
                        console.log(`ðŸ“‹ Showing outfit info: ${favoriteOutfit.name}`);
                    }
                } else {
                    console.log('No saved outfits found for overlay');
                }
            })
            .catch(error => console.log('No outfit data available:', error));
    }

    // FIXED: Load avatar stats using your actual APIs
    async function loadAvatarStats() {
        try {
            // Load outfit count from your API
            const outfitsResponse = await fetch('/api/outfits/saved');
            if (outfitsResponse.ok) {
                const outfitsData = await outfitsResponse.json();
                const outfitsCountElement = document.getElementById('avatar-outfits-count');
                if (outfitsCountElement) {
                    outfitsCountElement.textContent = outfitsData.count || outfitsData.outfits?.length || 0;
                }
            }

            // Load wardrobe items count from your API
            const wardrobeResponse = await fetch('/api/wardrobe-items');
            if (wardrobeResponse.ok) {
                const wardrobeData = await wardrobeResponse.json();
                const totalItems = Object.values(wardrobeData).reduce((sum, items) => sum + items.length, 0);
                const itemsCountElement = document.getElementById('avatar-items-count');
                if (itemsCountElement) {
                    itemsCountElement.textContent = totalItems;
                }
            }

            const createdDateElement = document.getElementById('avatar-created-date');
            if (createdDateElement) {
                createdDateElement.textContent = '7'; // You can calculate this from user creation date
            }

        } catch (error) {
            console.error('Error loading avatar stats:', error);
        }
    }

    // Calendar Preview System - FIXED TO LOAD IMMEDIATELY
    function initializeCalendarPreview() {
        console.log('ðŸ“… Initializing Calendar Preview...');

        // FIXED: Set the title immediately
        updateCalendarTitle();

        // FIXED: Load calendar data immediately
        loadMiniCalendar();
        loadUpcomingOutfits();
    }

    function updateCalendarTitle() {
        const titleElement = document.getElementById('mini-calendar-title');
        const monthBadge = document.getElementById('calendar-month');

        const monthName = new Date(currentCalendarYear, currentCalendarMonth - 1).toLocaleDateString('en-US', { month: 'long' });

        if (titleElement) {
            titleElement.textContent = `${monthName} ${currentCalendarYear}`;
        }
        if (monthBadge) {
            monthBadge.textContent = monthName;
        }
    }

    // FIXED: Load calendar using your actual API
    async function loadMiniCalendar() {
        const grid = document.getElementById('mini-calendar-grid');

        try {
            console.log(`ðŸ“… Loading calendar for ${currentCalendarYear}-${currentCalendarMonth}`);

            // Update title first
            updateCalendarTitle();

            // FIXED: Load calendar data from your actual API
            const response = await fetch(`/api/calendar/outfits?year=${currentCalendarYear}&month=${currentCalendarMonth}`);
            let calendarData = {};

            if (response.ok) {
                const data = await response.json();
                calendarData = data.outfits || {};
                console.log(`âœ… Loaded calendar data:`, Object.keys(calendarData).length, 'days with outfits');
            } else {
                console.log('Calendar API not available, showing empty calendar');
            }

            generateMiniCalendar(currentCalendarYear, currentCalendarMonth, calendarData);

        } catch (error) {
            console.error('Error loading calendar:', error);
            generateMiniCalendar(currentCalendarYear, currentCalendarMonth, {});
            updateCalendarTitle();
        }
    }

    function generateMiniCalendar(year, month, calendarData = {}) {
        const grid = document.getElementById('mini-calendar-grid');
        if (!grid) return;

        const today = new Date();
        const firstDay = new Date(year, month - 1, 1);
        const startDate = new Date(firstDay);

        const dayOfWeek = firstDay.getDay();
        const daysToSubtract = dayOfWeek === 0 ? 6 : dayOfWeek - 1;
        startDate.setDate(firstDay.getDate() - daysToSubtract);

        grid.innerHTML = '';

        // Add day headers
        const dayHeaders = ['M', 'T', 'W', 'T', 'F', 'S', 'S'];
        dayHeaders.forEach(day => {
            const dayElement = document.createElement('div');
            dayElement.className = 'calendar-day';
            dayElement.style.fontSize = '11px';
            dayElement.style.fontWeight = 'bold';
            dayElement.style.background = '#f8f9fa';
            dayElement.style.color = '#6c757d';
            dayElement.style.minHeight = '40px';
            dayElement.innerHTML = `<div class="calendar-day-number">${day}</div>`;
            grid.appendChild(dayElement);
        });

        // Add calendar days
        for (let i = 0; i < 35; i++) {
            const currentDate = new Date(startDate);
            currentDate.setDate(startDate.getDate() + i);

            const dayElement = document.createElement('div');
            dayElement.className = 'calendar-day';

            const dayNumber = currentDate.getDate();

            if (currentDate.getMonth() === month - 1) {
                if (currentDate.toDateString() === today.toDateString()) {
                    dayElement.classList.add('today');
                }

                // FIXED: Check your actual calendar data
                const dayOutfit = calendarData[dayNumber];
                if (dayOutfit && dayOutfit.outfit_items && dayOutfit.outfit_items.length > 0) {
                    dayElement.classList.add('has-outfit');
                    dayElement.title = `${dayOutfit.outfit_items.length} item(s) planned`;

                    dayElement.innerHTML = `
                        <div class="calendar-day-number">${dayNumber}</div>
                        <div class="calendar-outfit-preview">
                            ${dayOutfit.outfit_items.slice(0, 3).map(item =>
                                `<div class="calendar-outfit-item"
                                     style="background-image: url('${item.file_path}')"
                                     title="${item.label}"></div>`
                            ).join('')}
                            ${dayOutfit.outfit_items.length > 3 ? `<div class="calendar-outfit-item" style="background: linear-gradient(135deg, #C8A68D, #9C7D68); display: flex; align-items: center; justify-content: center; font-size: 10px; color: white; font-weight: bold;">+${dayOutfit.outfit_items.length - 3}</div>` : ''}
                        </div>
                    `;
                } else {
                    dayElement.innerHTML = `<div class="calendar-day-number">${dayNumber}</div>`;
                }
            } else {
                dayElement.style.opacity = '0.3';
                dayElement.innerHTML = `<div class="calendar-day-number">${dayNumber}</div>`;
            }

            grid.appendChild(dayElement);
        }
    }

    // FIXED: Load upcoming outfits from your actual API
    async function loadUpcomingOutfits() {
        const container = document.getElementById('upcoming-outfits-list');
        if (!container) return;

        try {
            const response = await fetch(`/api/calendar/upcoming?limit=5`);
            let upcomingOutfits = [];

            if (response.ok) {
                const data = await response.json();
                upcomingOutfits = data.upcoming || [];
            } else {
                // If your API doesn't have this endpoint yet, show empty
                upcomingOutfits = [];
            }

            container.innerHTML = '';

            if (upcomingOutfits.length === 0) {
                container.innerHTML = '<p class="text-muted small">No upcoming outfits planned</p>';
                return;
            }

            upcomingOutfits.forEach(outfit => {
                const outfitElement = document.createElement('div');
                outfitElement.className = 'outfit-item-mini';
                outfitElement.innerHTML = `
                    <div class="outfit-date-mini">${outfit.date}</div>
                    <div class="flex-grow-1">
                        <div class="fw-bold small">${outfit.name}</div>
                        <small class="text-muted">${outfit.items.join(', ')}</small>
                    </div>
                `;
                container.appendChild(outfitElement);
            });

        } catch (error) {
            console.error('Error loading upcoming outfits:', error);
            container.innerHTML = '<p class="text-muted small">Error loading outfits</p>';
        }
    }

    // FIXED: Dashboard Stats using your actual APIs
    async function loadDashboardStats() {
        try {
            const wardrobeResponse = await fetch('/api/wardrobe-items');
            if (wardrobeResponse.ok) {
                const wardrobeData = await wardrobeResponse.json();
                const totalItems = Object.values(wardrobeData).reduce((sum, items) => sum + items.length, 0);
                const totalElement = document.getElementById('wardrobe-total-items');
                if (totalElement) {
                    totalElement.textContent = totalItems;
                }
            }

            const outfitsResponse = await fetch('/api/outfits/saved');
            if (outfitsResponse.ok) {
                const outfitsData = await outfitsResponse.json();
                const outfitsElement = document.getElementById('wardrobe-outfits');
                if (outfitsElement) {
                    outfitsElement.textContent = outfitsData.count || outfitsData.outfits?.length || 0;
                }
            }

            const favoritesElement = document.getElementById('wardrobe-favorites');
            if (favoritesElement) {
                // You can calculate favorites from your outfits data
                favoritesElement.textContent = '12';
            }

        } catch (error) {
            console.error('Error loading dashboard stats:', error);
        }
    }

    // Utility Functions
    function createWeatherCard(weather) {
        return `
            <div class="weather-card" data-city="${weather.city}">
                <div class="d-flex align-items-center justify-content-between">
                    <div class="d-flex align-items-center">
                        <img src="https://openweathermap.org/img/wn/${weather.icon}@2x.png"
                             alt="Weather icon"
                             class="weather-icon me-3">
                        <div>
                            <h6 class="mb-1">${weather.city}</h6>
                            <div class="fw-bold text-primary">${weather.temperature}Â°C</div>
                            <small class="text-muted">${weather.description}</small>
                        </div>
                    </div>
                    <button class="btn btn-link text-danger delete-city"
                            data-city="${weather.city}"
                            title="Remove city">
                        <i class="bi bi-x-lg"></i>
                    </button>
                </div>
            </div>
        `;
    }

    function showToast(message, type = 'info') {
        const toast = document.getElementById('dashboardToast');
        const toastMessage = document.getElementById('toastMessage');

        if (toast && toastMessage) {
            const toastInstance = new bootstrap.Toast(toast);
            toastMessage.textContent = message;

            const header = toast.querySelector('.toast-header');
            if (header) {
                header.className = `toast-header ${type === 'error' ? 'bg-danger text-white' : 'bg-light'}`;
            }

            toastInstance.show();
        }
    }

    // Global Functions
    window.refreshAvatar = function() {
        showToast('Refreshing avatar...', 'info');
        loadAvatarPreview();
        loadAvatarStats();
    };

    window.refreshCalendar = function() {
        showToast('Refreshing calendar...', 'info');
        loadMiniCalendar();
        loadUpcomingOutfits();
    };

    window.refreshWeather = function() {
        showToast('Refreshing weather...', 'info');
        location.reload();
    };

    window.navigateCalendar = function(direction) {
        currentCalendarMonth += direction;

        if (currentCalendarMonth < 1) {
            currentCalendarMonth = 12;
            currentCalendarYear--;
        } else if (currentCalendarMonth > 12) {
            currentCalendarMonth = 1;
            currentCalendarYear++;
        }

        const monthName = new Date(currentCalendarYear, currentCalendarMonth - 1).toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
        showToast(`Loading ${monthName}...`, 'info');
        loadMiniCalendar();
    };
});
</script>
{% endblock %}